# repeat エフェクト（累積/非累積モード切り替え）改善計画

目的: `repeat` エフェクトに「累積モード」と「非累積モード」を追加し、  
現行の振る舞いを維持しつつ、元ジオメトリを等間隔に並べる用途にも使えるようにする。

## スコープ

- 対象:
  - `src/effects/repeat.py`
  - 必要に応じてテスト: `tests/effects/test_repeat_*.py`（新規追加）
  - ドキュメント/メタ情報: `repeat.__param_meta__` と関数 docstring
- 非対象（今回やらないこと）:
  - 他エフェクトの API/挙動変更
  - Parameter GUI の UI デザイン変更
  - キャッシュ鍵生成や署名仕様の変更

## チェックリスト（大項目）

- [x] A. 仕様整理（パラメータ設計）
- [x] B. 実装変更（累積/非累積分岐）
- [ ] C. docstring / `__param_meta__` 更新
- [ ] D. テスト追加・既存テスト確認
- [ ] E. フォローアップ・追加検討事項整理

以下で各項目を細分化する。

---

## A. 仕様整理（パラメータ設計）

目的: 新しい bool 引数の名前/既定値/挙動を明確にする。

- [x] A-1. 新規引数名を決める
  - 採用: `cumulative: bool = True`（現行挙動をデフォルトとして維持）
- [x] A-2. 累積モード時の仕様を整理
  - 現行挙動をそのまま維持:
    - スケール: `current_scale *= scale`
    - 回転: `angles_rad_step * (n + 1)` を前回結果に適用
    - 平行移動: `offset * (n + 1)` を前回結果に適用
- [x] A-3. 非累積モード時の仕様を整理
  - ベース座標は常に「元ジオメトリ `coords`」とする。
  - 各コピー n（0-origin）について:
    - 回転/平行移動は「ステップ番号に応じた量」を元座標から直接適用する。
      - 例: offset は `offset * (n + 1)` で 0, d, 2d, ... に等間隔配置。
    - スケールは累積モードと同様に `current_scale *= scale` を用い、コピー番号に応じてサイズを変化させる。
- [x] A-4. 既存スケッチへの互換性方針を明文化
  - 新規引数の既定値で「現行挙動と完全互換」にする。
  - 既存コードには変更不要とする。
- [x] A-5. docstring にどう記述するかの方針決定
  - 先頭行は現行の概要を維持。
  - Parameters で「累積モード/非累積モードの違い」を簡潔に説明。

**要: ユーザー確認ポイント 1**  
→ 非累積モードでのスケール挙動（全コピー同一サイズ vs ステップごとに変化）と、  
引数名 `cumulative`（既定 True）で問題ないか確認したいです。

---

## B. 実装変更（累積/非累積分岐）

目的: `repeat` 実装に分岐を追加し、bool 引数でモードを切り替えられるようにする。

- [x] B-1. 関数シグネチャに bool 引数を追加
  - 位置: `count` 以後のキーワード引数として追加（後方互換重視）。
  - 例: `cumulative: bool = True`。
- [x] B-2. 累積モード時のコードパスを明示
  - 現行ロジックを `if cumulative:` ブロックにまとめる。
- [x] B-3. 非累積モード用のコードパスを追加
  - ベース座標 `base_coords = coords.copy()`（またはコピーを避けられる範囲で最小限）。
  - ループ内で `n` ごとに `_apply_transform_to_coords` を呼び出し、結果から各線を `lines` に積む。
- [x] B-4. 早期リターン条件の再確認
  - `count <= 0` / `g.is_empty` / `offsets.size <= 1` の振る舞いが変わらないことを確認。
- [x] B-5. numba JIT 対応の確認
  - 既存の `_apply_transform_to_coords` / `_update_scale` は変更最小限に保つ。
  - 必要であれば新規の簡単なヘルパ関数を追加。

---

## C. docstring / `__param_meta__` 更新

目的: UI や補完から新モードが分かるようにし、AGENTS の「単一情報源」ルールを満たす。

- [x] C-1. `repeat` 関数の docstring を更新
  - Parameters に新規 bool 引数を追加。
  - 累積/非累積モードの違いを 1〜2 行で説明。
- [x] C-2. `repeat.__param_meta__` に bool パラメータを追加
  - 例: `"cumulative": {"type": "bool"}`。
  - レンジ指定は不要（bool のため）。
- [x] C-3. docstring と `__param_meta__` の既定値/意味が一致しているか確認。

---

## D. テスト追加・既存テスト確認

目的: モード追加により既存挙動を壊していないことと、新機能が期待通りであることを確認する。

- [x] D-1. `tests/effects/test_repeat_basic.py`（仮）を新規作成
  - 累積モードでの位置/スケールが現行と同じことを確認するテスト。
  - 非累積モードで「等間隔に並ぶ」ことを確認するテスト。
- [x] D-2. `count=0` / 入力空ジオメトリなど、no-op 条件のテストを追加。
- [ ] D-3. `auto_center=True/False` と `pivot` の組み合わせで挙動が破綻していないか確認。
- [ ] D-4. 変更ファイルに対して `ruff` / `mypy` / 対象テストのみ `pytest` を実行。

---

## E. フォローアップ・追加検討事項

目的: 今回の変更では扱わないが、今後検討したい点をメモしておく。

- [ ] E-1. `repeat` の UI 表示テキスト/ヘルプに「等間隔コピー」用途を明示するか検討。
- [ ] E-2. 将来的に「コピー番号 `n` をエクスポートするパラメータ」を追加する可能性（例えばモジュレーション用途）。
- [ ] E-3. ベンチマーク: 大きな頂点数・複製数での性能を軽く確認し、顕著な劣化があれば最適化案をメモ。

---

## メモ / 質問候補

- 非累積モードでのスケール挙動（A-3）の仕様をどちらにするか、事前に決めたいです。
- 引数名を `cumulative` 以外にしたい・UI 上のラベル案などあれば、このファイルに追記して運用したいです。
