# displace エフェクト: 振幅グラデーション引数追加 計画

## ゴール

- `effects.displace` に、座標軸方向に振幅を変化させる 3 成分ベクトル引数（仮称: `amplitude_gradient`）を追加する。
- `fill.spacing_gradient` と同様に、既存のパラメータを壊さず「勾配 0 で完全互換」「少数のパラメータで直感的に制御できる」実装とする。

## TODO: 仕様設計（要確認）

- [x] 新しい引数名を決める（案: `amplitude_gradient`, `amplitude_mm_gradient`）。`amplitude_mm` との関係が分かる名称にする。
- [x] 勾配の定義を決める（例: 各頂点の正規化座標 `t_axis` に対して `amp_axis(t) = amp_axis * f(gradient_axis, t)` として変化させるか、線形モデル `amp_axis(t) = amp_axis * (1 + k_axis * (t - 0.5))` にするか）。
- [x] 正規化に使う座標系を決める（案: ジオメトリのバウンディングボックスを使い、各軸ごとに `t_axis = (coord_axis - min_axis) / (max_axis - min_axis + eps)` を 0..1 にマップする）。
- [x] 勾配パラメータの単位とレンジを決める（案: 無次元の係数として `[-4.0, 4.0]` 程度、0 で一様振幅、正負で増減方向を切り替え）。
- [x] 片側に強く寄る極端な勾配で振幅が 0 近傍や負値にならないように、クランプ方針を決める（例: `amp_axis(t)` を 0 以上にソフトクランプするか、係数レンジで抑制するか）。
- [x] `amplitude_mm=0` / `(0,0,0)` のときは、勾配の値にかかわらず常に no-op になるようにするかどうかを明確にする（互換性優先なら no-op 固定）。
- [x] 時間パラメータ `t_sec` とは独立した「静的な空間勾配」として扱うか、将来的な時間依存拡張余地を残すかを整理する（現時点では前者のみ実装）。
- [x] 単一 float 指定（例: `amplitude_gradient=0.5`）を全軸共通として受け入れるか、常に 3 成分ベクトル専用にするかを決める（Parameter GUI と一貫した UX を優先）。

## TODO: API / メタデータ

- [x] `src/effects/displace.py` の `displace.__param_meta__` に新しいベクトル勾配パラメータを追加し、`min/max/step` を軸ごと（3 要素タプル）で定義する。
- [x] 上記 `__param_meta__` と docstring の説明（範囲・既定値・単位）を同期させる。
- [ ] `src/api/__init__.pyi` の `displace` シグネチャに新しい引数を追加し、`# meta:` コメントにも `amplitude_gradient` の RangeHint（ベクトル範囲）を追加する。
- [ ] スタブ生成スクリプト `tools/gen_g_stubs.py` が `displace.__param_meta__` の新パラメータを正しく拾えるか確認し、必要ならテンプレート/マッピングを更新する。
- [ ] `src/api/__init__.pyi` の stub を `python -m tools.gen_g_stubs` で再生成し、手動編集箇所と矛盾がないか確認する。
- [ ] 公開 API 変更として、`mypy src/effects/displace.py src/api/__init__.pyi` が通ることを確認する。

## TODO: 実装

- [x] `effects.displace.displace` の引数リストに新パラメータを追加し、既定値（例: `(0.0, 0.0, 0.0)`）を設定する。
- [x] 新パラメータの入力を `float | Vec3` として受け取り、`ensure_vec3` を用いて `(gx, gy, gz)` のタプルに正規化するかどうかを決めて実装する。
- [x] `displace` 内で座標配列 `coords` のバウンディングボックス（各軸の `min/max`）を計算し、勾配計算に使う正規化情報（中心または 0..1 スケール）を求める。
- [x] `_apply_noise_to_coords` のシグネチャを拡張し、振幅グラデーション関連の引数（例: 勾配タプルと正規化用スケール）を受け取れるようにする。
- [x] `_apply_noise_to_coords` のループ内で各頂点の軸方向正規化座標 `t_axis` を計算し、仕様で決めたモデルに基づいて `amp_x/amp_y/amp_z` を頂点ごとに決定する。
- [x] 勾配がすべて 0 の場合は、現在と同じ「一様振幅」の分岐にフォールバックし、余計な計算を避ける（Numba 最適化を維持）。
- [x] 軸方向のスケールが 0（全点が同じ座標）などの退化ケースでは、該当軸の勾配を無視する（例: `t_axis=0.5` とみなす）ことで数値安定性を保つ。
- [ ] `amplitude_mm=(ax, ay, az)` かつ `amplitude_gradient=(gx, gy, gz)` の組み合わせで、少なくとも「勾配 0」「片軸のみ非ゼロ」「正負の勾配」の代表ケースが直感的な揺れ方になるように係数を調整する。
- [x] NumPy/Numba 双方でサポートされる演算のみを使うように `_apply_noise_to_coords` 内の実装を確認し、必要に応じて型キャスト（`np.float32`）を追加する。

## TODO: テスト / 検証

- [x] `tests/effects/test_displace_minimal.py` に「勾配 0 のときは従来挙動と完全一致する」テストを追加する。
- [x] `amplitude_mm=0.0` / `(0.0,0.0,0.0)` かつ `amplitude_gradient` 任意の組み合わせで、出力が入力のコピーになることを確認するテストを追加する（互換性回帰テスト）。
- [ ] 片軸にのみ勾配を与えた場合に、その軸方向のノイズ振幅が座標に応じて変化していること（例: 端点と中央で揺れ量が異なること）を数値的に検証する簡易テストを追加する。
- [ ] 正/負/ゼロ勾配、float 指定と Vec3 指定、バウンディングボックスが極端に薄い図形（ほぼ線・点）などの代表ケースを含むテストセットを整備する。
- [x] `pytest -q tests/effects/test_displace_minimal.py` を実行し、既存テストを含めてすべて緑であることを確認する。
- [ ] 公開 API 変更の副作用として `tests/stubs/test_pipeline_stub_sync.py` が失敗しないか確認し、必要なら期待値やコメントを更新する。
- [ ] （必要に応じて）`pytest -q tests/perf/test_catalog_perf.py -k displace` を走らせ、パフォーマンス退行が体感できないレベルに収まっているかを目視で確認する。

## TODO: ドキュメント / メンテナンス

- [x] `effects.displace` の docstring に新しいパラメータの説明を追加し、`amplitude_mm` との関係（基準振幅 + 勾配による変化）を短く明記する。
- [ ] Parameter GUI 周辺のドキュメント（`docs/` や `architecture.md` 内で displace に言及している箇所）があれば、新しいパラメータを反映させる。
- [x] 新パラメータの RangeHint（`__param_meta__` の min/max/step）と量子化ステップが他のエフェクト（特に `fill.spacing_gradient`）と大きく乖離していないか確認し、必要なら調整する。
- [ ] このファイルに実装完了状況（チェックボックス）と、最終的な仕様の要点（なぜこのモデルにしたか）を簡潔に追記する。

## メモ / オープンな論点

- 勾配のモデルを、`fill.spacing_gradient` のような指数関数ベースのプロファイルに寄せるか、よりシンプルな線形モデルにするか（表現力と直感性のバランス）は要検討。まずはシンプルな線形モデルで実装する。
- 勾配値のレンジ設定により、どの程度まで「気持ちよく揺れる」範囲をデフォルトとし、極端な値はどこまで許容するか（UI と実装の両面で詰める必要あり）。
- 世界座標軸ベースの勾配とするか、ジオメトリのローカル軸（例: PCA など）に基づく勾配を将来サポートするかは、当面は世界座標軸ベースに固定する案がシンプル。まずはシンプルな世界座標軸ベースのみをサポートする。
- 実際のスケッチで使用してみて、`amplitude_mm` と `amplitude_gradient` の組み合わせでどの程度の表現の幅が得られるかを確認し、必要であれば将来の非線形プロファイル追加余地を残す。
