# offset エフェクト改善チェックリスト（提案）

目的
- `src/effects/offset.py` の挙動/設計/ドキュメントをリポ規約に整合させ、幾何学的に予測可能なオフセット（膨張/収縮）を提供する。

スコープ
- 主対象: `src/effects/offset.py`
- 付随影響の可能性: `src/util/geom3d_ops.py`, `src/api/__init__.pyi`, `architecture.md`, `tests/effects/*`

方針（原則）
- 値変換レイヤ撤廃（実値を受け取り、RangeHint は UI 表示のみ）。
- 幾何の意味を壊す処理（全体スケーリング等）は排除し、Shapely の `buffer` 結果を忠実に返す。
- docstring と `__param_meta__` を同期。最小限の利用情報のみを記載。

---

進捗（このファイルの目的）
- [x] 改善アクションのチェックリスト作成（本ファイル）
- [ ] 以降の項目は未着手（実装前）

---

改善アクション（チェックリスト）

1) 動作仕様の是正
- [x] 距離クランプ（[0, 25] への丸め）を撤廃し、負値を許容（収縮を実現）。0 は no-op を維持。
- [ ] グローバルスケーリング補正を削除（`_scaling` 関数とその呼び出しを除去）。
- [ ] `join` と `segments_per_circle` の入力検証を追加し、無効値は `ValueError` で明確化。

2) 3D 復元の安定化
- [ ] 2 点ラインの z 復元方式を決定（util 側で平行移動量を保持するか、エフェクト側ローカル対応か）。
- [ ] 選択方式に基づき実装し、一定 z の入力で z が保持されることを確認。

3) 出力形状の扱い（穴の扱い）
- [ ] 内環（interiors）の扱い方針を決定（無視/返却）。
- [ ] 方針に沿って `Polygon` の `interiors` を抽出するか、無視する旨を docstring に明記。

4) Shapely 互換性
- [ ] `resolution` → `quad_segs` への置換、もしくは v1/v2 の両対応（キーワード切替）方針を決定。
- [ ] `join_style` の指定を文字列か Enum かで方針を明記し、実装を揃える。

5) ドキュメント/メタ/スタブ同期
- [ ] 関数 docstring を規約準拠（先頭 1 行 + Parameters）に整備し、既定値/レンジ/no-op 条件を同期。
- [ ] `__param_meta__` のレンジ/step を同期（例: `distance`: min -25.0, max 25.0, step 0.1／`segments_per_circle`: min 1, step 1）。
- [ ] API スタブ `src/api/__init__.pyi` の meta 範囲を同期（Ask-first: スタブ再生成を伴う）。
- [ ] `architecture.md` に必要な差分があれば参照箇所付きで更新。

6) テスト追加/更新
- [ ] 負距離（収縮）で妥当な形状が得られる（小入力のスモーク）。
- [ ] `segments_per_circle <= 0` で `ValueError` が発生する。
- [ ] `join` が不正値で `ValueError` が発生する。
- [ ] 内環（穴）の扱いに関する仕様テスト（返却する/しない）。
- [ ] 2 点ラインの z 復元（一定 z の保持）。
- [ ] 既存テスト（joins/zero distance）の維持確認。

7) 品質チェック（変更ファイル限定）
- [ ] `ruff check --fix {changed}` / `black {changed}` / `isort {changed}` を通す。
- [ ] `mypy {changed}` を通す。
- [ ] `pytest -q -m smoke` または対象テストを指定して通す。
- [ ] 公開 API 影響時はスタブ同期テスト（`tests/stubs/test_g_stub_sync.py`）を緑に。

---

事前確認事項 / 質問（要ご判断）
1. 内環（穴）の扱い: バッファ結果の `Polygon.interiors` を出力に含めますか？ それとも外環のみとしますか？
2. 距離の表示レンジ: UI RangeHint を `[-25.0, 25.0]` 程度に拡張で問題ありませんか？（実値はクランプしない方針）
3. Shapely 互換: v1/v2 の両対応にしますか？ 可能なら `quad_segs` 優先、未対応環境では `resolution` にフォールバックの実装を提案します。
4. 2 点ラインの z 復元: `util/geom3d_ops.py` を改善して全体最適にしますか？ それとも `offset` 内でローカル対処に留めますか？
5. 例外ポリシー: 無効パラメータは `ValueError` で統一し、メッセージは短く具体（期待値/実値）でよいですか？
6. スタブ再生成: `src/api/__init__.pyi` 更新は Ask-first 対応が必要です。許可の可否をご指示ください。

---

影響/互換性
- 距離クランプ撤廃と負距離対応により、従来（クランプ+全体スケーリング）の結果と互換がなくなります（破壊的変更）。
- `__param_meta__` の範囲変更に伴い、UI スライダのレンジ/粒度が変化します。
- テストは追加/更新が必要です。

実行計画（簡潔）
1. 仕様決定（本ファイルの質問合意）
2. 小粒度で実装（距離/スケーリング→検証→3D復元→穴→互換→ドキュメント）
3. テスト追加/更新（負距離・検証・穴・z 復元）
4. ドキュメント/スタブ同期（Ask-first で許可後）
5. 変更ファイル限定の Lint/Type/Test を緑化
