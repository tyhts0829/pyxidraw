# src モジュール改善計画（effects/shapes 除外）

目的: 既存設計レビュー（`src_architecture_review.md`）で挙げた懸念を改善するための作業計画。コード着手前にタスク分割を明示し、合意を得る。

## チェックリスト

### A. ランナー（api/sketch.py）の責務分割
- [ ] ランナーの主機能を段階に分解する案をまとめる（設定解決、バックエンド結線、UI/イベント束ね、終了処理）。
- [ ] 設定/依存構築を担う小さな構造体/関数のスケッチを作成（引数と戻り値を定義）。
- [ ] ワーカー・レンダラー結線を担当するオーケストレータの境界を設計（依存注入方針を決める）。
- [ ] 終了処理・例外処理の共通化案を提示（テスト容易性と再利用性を考慮）。
- [ ] 分割後にも既存 CLI/API の挙動を維持するための移行手順を整理（互換性ポリシーの明記）。

### B. Parameter GUI 依存の明示化
- [ ] `ShapesAPI`/`PipelineBuilder` が UI ランタイムに依存する部分を洗い出し、明示的 DI かプロバイダ層導入の方向性を決める。
- [ ] ContextVar をラップする薄いプロバイダのインタフェース案を作成（UI 無効時のデフォルト挙動を定義）。
- [ ] `ParameterManager` の責務を「設定→構成生成」と「ランタイム起動/寿命管理」に分割する設計草案を用意。
- [ ] 設計変更後の API 影響範囲と必要な docstring/architecture.md 追記項目を列挙。

### C. キャッシュ戦略の一元管理
- [ ] `Pipeline` compiled/result キャッシュと shape/prefix キャッシュの現状設定/寿命を整理する表を作成。
- [ ] キャッシュ設定・クリア API・HUD 向け統計を一元化する仕組み（サービスまたはユーティリティ）の設計案を起こす。
- [ ] ワーカープロセス境界でのキャッシュ初期化ポリシーを決定し、実装方針を記載。
- [ ] 設計更新に伴う設定キー/環境変数の扱いを確認し、変更が必要ならマイグレーション手順をまとめる。

### D. スタイル抽出の責務整理
- [ ] `style` ステップ除去とレイヤー化をパイプライン側に寄せる新しいデータ構造案（例: StyledGeometry）を作成。
- [ ] Worker 層で保持すべき最小責務を定義し、コード変更の影響範囲（tests/runtime, renderer など）を洗い出す。
- [ ] 仕様変更後の互換性（既存の style エフェクト呼び出しパターン）を確認し、必要なフォールバック有無を決める。

### E. ドキュメント/同期
- [ ] 変更に伴い `architecture.md` へ追記すべき項目を列挙（データフロー、キャッシュ寿命、UI 依存境界など）。
- [ ] 必要なテスト追加/更新の候補を整理（ユニット/統合/スタブ同期）。

## メモ
- 実装着手前に上記チェックリスト項目を合意し、優先順位を決めてから進めます。
