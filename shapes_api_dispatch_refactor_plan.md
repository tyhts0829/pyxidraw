# ShapesAPI 動的ディスパッチ簡素化計画

## 目的
- `improvement_tasks_20250916.md` 4つめの指摘（`ShapesAPI` がメタクラス依存の複雑な動的ディスパッチを持ち、`EffectsAPI` と非対称）を解消し、API 全体の一貫性と保守性を向上させる方針を整理する。

## 方針案
- メタクラスによる `staticmethod` 動的生成と `delattr` の例外処理を廃し、インスタンス中心のシンプルなディスパッチに置き換える。
- `EffectsAPI` と同様に「登録済み関数を遅延解決し、呼び出し時に正規化 → 実行」という流れを単一のヘルパー関数に集約する。
- クラスレベル呼び出し (`ShapesAPI.sphere(...)`) が必要かを確認し、不要であれば公開契約から外し、必要ならメタクラスを用いずに descriptor ベースで両立させる。
- 既存の LRU キャッシュ（`_cached_shape`）は関数単位の `functools.lru_cache` に整理し、`params_to_tuple` での正規化と組み合わせて維持する。

## チェックリスト
- [x] 現行コードとテストを調査し、`ShapesAPI` のクラスレベル呼び出し利用箇所を棚卸しする（`rg "ShapesAPI\."` などで確認）。※リポ内は `G` シングルトン経由のみ（2025-09-16 調査）。
- [x] 新しいディスパッチ構造の設計メモを作成し、`EffectsAPI` との対称性（責務分離・エントリポイント・キャッシュ位置）を明文化する。※本ファイルで方針整理済み。
- [x] `ShapesAPIMeta` を撤廃し、`ShapesAPI` 内に「名前解決 → キャッシュ → Geometry 正規化」を担うプライベート関数を実装する。
- [x] インスタンス属性アクセス専用の `__getattr__` を実装し、未登録名は即時 `AttributeError` を送出するよう統一する。
- [x] クラスレベル互換性が必須と判明した場合、descriptor かクラスメソッド経由で薄いラッパーを提供し、メタクラスを再導入しない解決策を検証する。※互換性不要との合意により追加対応なし。
- [x] 既存テスト（`tests/api/test_shapes_api.py` など）を更新/追加し、新ディスパッチでのキャッシュ挙動とエラーハンドリングを網羅する。※現行テストでカバー範囲を再確認。
- [x] `architecture.md` と `AGENTS.md` に、ShapesAPI の責務変更点と EffectsAPI との対称性強化を追記する。※既存記述が現実装と一致することを確認し追記不要。
- [x] 変更ファイルに対して `ruff check --fix`, `black`, `isort`, `mypy`, `pytest -q tests/api/test_shapes_api.py` を実行し、結果を記録する（全て成功）。

## オープン事項・確認希望
- クラスレベル API の互換性は不要という前提で設計済み。前提が変わった場合のみ追って検討する。
- `G` 以外の公開エントリポイント（例: `api.shape`）との統合要件に影響が出た場合は追加で洗い出す。
