# dpg_window.py コードレビュー & 改善計画（ドラフト）

対象ファイル: `src/engine/ui/parameters/dpg_window.py`

## 現状レビュー（要約）

- 責務の分離
  - ParameterWindow は DPG コンテキスト/ビューポート生成、ドライバ制御、ParameterStore との橋渡しを一箇所で担っており、役割は比較的明確。
  - レイアウト/テーマを別クラス（`ParameterWindowContentBuilder` / `ParameterWindowThemeManager`）に委譲している点は良く、UI レイヤの分割方針に沿っている。
- 初期化処理（`__init__`）
  - DPG コンテキスト/ビューポート生成、フォント/テーマ初期化、ルートウィンドウ構築、Descriptor マウント、Store 購読登録、auto_show によるドライバ起動までを 1 メソッド内で順番に記述しており、読みながら「どこからどこまでが何の責務か」を追いにくい。
  - 例外処理は最小限に留めているが、フォント設定や購読解除など一部で `except Exception: pass` としており、障害時の観測可能性と静かに失敗させたい意図が混在して見える。
- 可視性制御（`set_visible`）
  - 外部インターフェースとして単純で、`_visible` と `_driver` の状態に応じて show/hide とドライバ開始/停止を切り替えており、振る舞いは分かりやすい。
  - ただし、`__init__` 側の `auto_show` ロジックと合わせて読む必要があり、「初期表示」と「その後の表示切り替え」の関係がコード上ではやや散らばっている。
- 終了処理（`close` / `_stop_driver`）
  - `_closing` フラグで `_tick` の副作用を止めつつ、購読解除 → ドライバ停止 → DPG の停止/非表示/コンテキスト破棄という順序をコメント付きで明示している点は良い。
  - `close` と `_stop_driver` の双方で `dpg.stop_dearpygui()` を呼び得る構造になっており、例外で保護されているとはいえ、責務が少し重複している。
  - 例外処理が階層的に分かれていて読みにくく、どの失敗がどこで握りつぶされるのかを一読で把握しづらい。
- ドライバ実装（`_start_driver` / `_stop_driver` / `_tick`）
  - pyglet clock を優先し、利用できない場合はスレッドで `dpg.start_dearpygui` を回すというフォールバック戦略はシンプルで理解しやすい。
  - `_driver` の実体が単なるタプル `("pyglet" | "thread", Any)` になっており、状態の意味が暗黙的で、ドライバ種別の増減時にバグを埋め込みやすい。
  - `_tick` で DPG の状態確認 → render → 例外ログという流れ自体は素直だが、`getattr` ベースの呼び出しと複数早期 return が続いており、ロジックの意図をコメント込みで整理すると読みやすくなりそう。
- ベースクラス（`ParameterWindowBase`）
  - 最小インターフェースを分離している点は良いが、メソッド本体が `return None` のみで、誤用時に静かに失敗するため、抽象クラス/Protocol として明示的に「実装必須」であることを表現すると安全性と可読性が上がる。

## 改善方針（高レベル）

- `ParameterWindow` の責務を「外部 API（コンストラクタ/可視性制御/close/mount）」と「内部実装（DPG コンテキスト/ドライバ/購読管理）」に分け、初期化と終了処理を小さなメソッドへ分割する。
- ドライバ状態表現をタプルから小さな構造（NamedTuple か簡単なクラス/Enum 的な表現）へ置き換え、`_start_driver` / `_stop_driver` / `_tick` の読みやすさと型安全性を高める（ただし過度な抽象化は避ける）。
- 例外処理を「静かに無視したいケース」と「ログを残したいケース」に分け、`logger` を通して異常系を一貫したスタイルで記録する。
- `ParameterWindowBase` の役割を明確化し、利用箇所に応じて抽象基底クラスもしくは Protocol への変更を検討する。

## 改善アクションチェックリスト（提案）

- [ ] `__init__` を以下のような私的メソッドに分割し、処理の塊ごとに役割を明示する  
      例: `_init_context_and_viewport()` / `_init_theme_and_content()` / `_init_store_subscription()` / `_init_auto_show()`
- [ ] `ParameterWindowBase` を抽象インターフェースとして整理し、未実装メソッドでは `NotImplementedError` を送出するか、`Protocol` へ置き換える（呼び出し側の期待に合わせて選択）。
- [ ] `close()` と `_stop_driver()` の責務を見直し、`dpg.stop_dearpygui()` を呼び出す位置を 1 箇所にまとめるか、少なくとも「どちらの経路で呼ぶのか」をコメントとロジックで明示する。
- [ ] `_tick()` 内の DPG 状態確認ロジックをヘルパーメソッド（例: `_should_close_from_dpg_state()`）に切り出し、早期 return の条件を整理して可読性を高める。
- [ ] ドライバ状態 `_driver` をタプルから専用型（NamedTuple や簡易クラス）に変更し、`kind` を `Literal["pyglet", "thread"]` などで表現して分岐を明示する。
- [ ] フォント設定失敗・ドライバ起動/停止失敗・購読解除失敗などの異常系で、どの程度ログを出すかを決め、`except Exception: pass` を必要最小限に絞る。
- [ ] コンストラクタ引数（`width` / `height` / `title` / `theme` / `auto_show`）に対する docstring を補強し、利用者がウィンドウ寿命と表示挙動を理解しやすくする。

## 確認してほしい点

- 上記レベルのメソッド分割（初期化の 3〜4 メソッド化、ドライバ状態専用型の導入）は、このモジュールに対して「やりすぎ」でないか。
- `ParameterWindowBase` を `Protocol` にする変更は、インターフェースとしての意図を明確にする一方で依存箇所を触る可能性がありますが、その範囲の変更は許容してよいか。
- ドライバ実装は現状の 2 パターン（pyglet / thread）に絞ったまま整理し、将来の拡張は必要になったタイミングで検討する方針で問題ないか。

※ このファイルは「レビュー結果と改善計画（ドラフト）」です。実際のコード変更は、上記チェックリスト内容についてご確認いただいた後の合意に基づいて行います。

