# 対策計画 — 緯度線のみ（latlon/rings, mode=0/1）で fill が効かない件

目的: 緯度線のみ（水平リング群）や縦リングのみの球ワイヤに対して、`effects.fill` が安定してハッチ線を生成するようにする。

前提/背景（現状整理）
- 図形全体は非共平面（リングが複数高度/複数平面に分散）。`fill` はグローバル共平面経路を使えず、各リングの個別処理へフォールバックする。
- 個別処理では XY 整列→スキャンライン（偶奇ペア）で生成するが、頂点と水平線が接触する等の端ケースで交点が偶数に揃わず、塗り線が 0 本になることがある。
- 小さなリング（極付近）では間隔計算や数値丸めの影響で y スキャン列が空/乏しくなることがある。

完了条件（DoD）
- 緯度線のみ／縦リングのみ／両方の各スタイルで、`fill(density>0)` が各リングに対して最低 1 本以上のハッチ線を生成する（remove_boundary の有無を問わず）。
- 角度/スケール/回転に対して見かけ密度が大きく破綻しない。

実装タスク（チェックリスト）

1) 平面グルーピング導入（非共平面の改善）
- [ ] リングを法線ベクトル（近似）でクラスタリングし、各平面グループ単位で共平面経路を適用（`build_evenodd_groups` + 共通 `spacing`）。
- [ ] グループ内の `scan_h` を用いた間隔決定（既存の共平面経路と同等）へ統一。
- [ ] グループごとの `angle_sets/angle_rad/density` サイクリングを維持。

2) 交点/スキャンの堅牢化（端ケース対策）
- [ ] y スキャン列に微小ジッタを導入（例: `y_values = arange(min_y, max_y, spacing) + 1e-6*diag` など）して頂点と正接するケースを回避。
- [ ] `find_line_intersections_njit` 入力ポリゴンの前処理: 連続重複点の削除、終端の重複頂点（first==last）の片方除去。
- [ ] 参照高さが極小のときは最小本数（例: 2 本）の保証ロジックを追加（`_spacing_from_height` のガード強化）。

3) フォールバック経路の平面整列強化
- [ ] `transform_to_xy_plane` の退避分岐（法線ゼロ）に PCA ベースの法線推定を追加（ほぼ一直線/数値不安定な三点に対処）。
- [ ] 中間演算は float64 で維持し、最終出力のみ float32 に戻す（既存方針と整合）。

4) パラメータ/挙動のオプション化（UI/互換性）
- [ ] `fill` に実験的フラグを追加（例: `planar_mode: 'auto'|'grouped'|'legacy'`、`scan_jitter_eps`）。デフォルトは `auto`（後方互換保持）。
- [ ] `remove_boundary=True` 既定の検討（視認性向上）。互換性のため今回は変更せず、ドキュメントで推奨値を案内。

5) テスト
- [ ] 単体: 緯度リングのみ（latlon mode=0）の複数 subdivision で、各リングに塗り線 > 0 を検証。
- [ ] 単体: 縦リングのみ（rings mode=1）で同様に検証。
- [ ] 端ケース: 極付近の微小リング、角度回転後、密度の低/高端で回帰テスト。
- [ ] 速度: 代表サイズで比較（現行 ±10% 以内を目安）。

6) ドキュメント/周知
- [ ] `docs/shapes.md` と `effects/fill` の説明に、非共平面入力時の挙動と推奨パラメータ（角度/密度/境界保持）を追記。

設計メモ/代替案（要確認）
- [ ] 「シルエット投影モード」: 球ワイヤから投影外周を 1 外環として抽出し、その内側を塗る（重いが視覚的一貫性は高い）。
- [ ] 「リング束ね塗り」: 近接リングを帯状に結合（ブリッジ短線分を追加）して面を構成→共平面塗り。見た目は良いが生成側の仕様が変わるため要検討。

リスク/影響
- 交点ジッタはパス形状に微小なずれを導入するため、厳密な幾何が必要なケースではオプトイン設定とする。
- 平面グルーピングは入力順依存を避けるため、法線の量子化/閾値設計が必要（回帰テストで検証）。

確認事項（ご承認ください）
- [ ] まずは「2) 交点/スキャンの堅牢化」と「3) フォールバック整列強化」を先行実装（低リスク・効果大）。
- [ ] 次に「1) 平面グルーピング導入」を追加（挙動改善の柱）。
- [ ] パラメータ/ドキュメントは最後にまとめて更新。

承認後、段階的に実装し、各ステップ完了ごとに本ファイルのチェックを更新して進捗を共有します。

