# Shift+V 録画「品質最優先モード」計画（提案）

目的: Shift+V（HUDなし録画）時は UI のフレームレート低下を許容し、動画品質（ジャギー無し・一定fps・フレーム欠落無し）を最優先にする。

---

## 方針概要
- 固定フレーム駆動（t を 1/fps 刻みで進める）で動画内時間を均一化。
- 単一描画パス（FBO 主体）で録画用にだけ正しく描画し、必要なら画面へブリット。
- 生成→描画→読み出し→エンコードをフレームごとに同期完了（取りこぼし無し）。
- UI は遅くなってよい（応答性よりも品質を優先）。

---

## タスク（チェックリスト）

Phase 1 — 小変更で効果大（品質最優先の骨格）
- [x] 固定タイムステップ記録
  - 録画中は `t` を厳密に `1/fps` ずつ進める（実時間 dt を使わない）。
  - 1フレーム: 幾何生成 → FBO描画 → 読み出し → エンコード → 次フレーム。
- [x] 単一描画パス（FBO 主）
  - 画面用の描画をやめ、FBO だけに描画。余力があれば FBO→画面へ blit（頻度を落としても可）。
- [x] ワーカー同期化（インライン）
  - 録画中は `WorkerPool(num_workers=0)` に切替え、1フレームごとに幾何生成の完了を待つ。
- [x] リソース事前確保・再利用
  - 録画開始時に FBO（MSAA + 解像先）, ビューポートなどを確保し録画中は再利用。
- [x] HUD/状態表示
  - 「品質最優先モード」を HUD に明示（REC とは別に小さなラベル等）。
- [x] DoD（受け入れ基準）
  - 動画の実フレーム数が `duration*fps` と一致。動きが均一（コマ飛び感なし）。
  - 既存の Shift+V 録画より fps ばらつきが明確に低減。

Phase 2 — 品質強化（任意）
- [ ] SSAA（スーパーサンプリング）
  - FBO を目標解像度の 2x で描画→ダウンサンプリング→エンコード（さらにジャギー低減）。
- [ ] コーデック設定の明示
  - `libx264` に `crf=18±2`（高画質）/ `preset=slow～slowest` / `pix_fmt=yuv420p`（互換）or `yuv444p`（最良）を指定。
- [ ] sRGB 対応（環境対応時）
  - `FRAMEBUFFER_SRGB` などが利用可能なら有効化を検討（見た目の一致向上）。
- [ ] DoD
  - V と Shift+V の画質差が視覚的に同等かそれ以上（SSAA採用時）。

Phase 3 — 安定化（任意）
- [ ] 読み出しの非同期化（PBO）
  - PBO を用いた非同期 `read` でフレーム時間を均一化（品質は維持したままばらつき低減）。
- [ ] 画面更新の最適化
  - 録画中は画面へのブリット頻度を抑制 or 録画完了後にまとめてプレビュー。
- [ ] フォールバック強化
  - MSAA/解像/非同期が失敗した場合の安全フォールバックと HUD 通知。
- [ ] DoD
  - 長時間録画でもフレーム時間のばらつきが小さく安定している。

---

## 設計ポイント
- 変更対象（想定）
  - `src/api/sketch.py`: 録画中の駆動モード切替（固定刻み / インライン化 / 単一描画パス）。
  - `src/engine/export/video.py`: FBO の事前確保・再利用、（任意）SSAA、PBO。
  - `src/engine/core/frame_clock.py`: 必要なら固定刻みの補助（現状でもスケジューラ制御で対応可）。
  - `src/engine/runtime/worker.py`: インライン実行パスの確認と必要な補助。
- 依存追加: なし（既存の `moderngl` と `imageio` 系で完結）。
- 失敗時は録画継続を優先（MSAA→非MSAAなど段階フォールバック）。

---

## 検証・メトリクス
- 動画フレーム数が `duration*fps` と一致すること。
- PNG 比較（V vs Shift+V）で輪郭の差が実用上見えないこと。
- 連続 60秒 録画でフレーム時間（推定）が安定していること（ばらつき減）。

---

## リスク / トレードオフ
- 実時間は大幅に遅くなる（意図どおり）。UI 応答も低下。
- SSAA/HiDPI/長時間でファイルサイズ/負荷が増加。
- 非対応ドライバでは MSAA/PBO がフォールバックされ、品質/安定性の一部低下あり。

---

以上。合意いただければ Phase 1 から順に実装します。
