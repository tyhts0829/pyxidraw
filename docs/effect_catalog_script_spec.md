どこで: `docs/effect_catalog_script_spec.md`（開発用仕様書）
何を: 全エフェクトをグリッド状にプレビュー表示（ラベル付き）する“実行一発”スクリプトの仕様
なぜ: 登録済みエフェクトをカタログ的に俯瞰し、見た目の差異を素早く比較・検証するため（CLI は不要）

**概要**
- スクリプトを実行すると、固定のベース形状に全エフェクトをそれぞれ 1 回ずつ適用し、ラベル付きプレビューを格子状（グリッド）に並べて画面に描画する。
- `main.py` と同じ実行モデル（`api.sketch.run(draw, ...)`）を用いる。戻り値は 1 つの `Geometry`（全セルを連結）。
- パラメータは 0..1 の正規化から実レンジに決定論的に変換し、各エフェクトに「効きが分かる」代表値を与える。

**配置/起動**
- 位置: `demo/effect_grid.py`
- 起動: `python demo/effect_grid.py`（引数なし）
- `main.py` 同様、先頭で `src/` を `sys.path` へ追加してローカル実行を簡便化。

**出力**
- 画面描画（ウィンドウ）。ファイル出力は行わない。
- キャンバスサイズはセルサイズ・列数・行数から自動決定（上書き可）。

**固定設定（ソース先頭の定数で調整）**
- `REFERENCE_SHAPE`: 参照形状の登録名（既定: `"polygon"` など）。
- `REFERENCE_SHAPE_PARAMS`: 参照形状に渡すパラメータ（例: `{"n_sides": 6}`）。
- `CELL_SIZE`: 各セルのサイズ `(width, height)`（既定: `(320, 320)`）。
- `COLUMNS`: 列数（既定: 5）。
- `PADDING`: セル内の余白（同一座標系）。
- `GAP`: セル間の間隔（同一座標系）。
- `LINE_THICKNESS`: `run(..., line_thickness=...)` へ渡す値。
- `CANVAS_SIZE`: ウィンドウサイズ（自動計算を上書きしたい場合に指定）。
- `NORMALIZED_DEFAULT`: 正規化入力の既定値（例: 0.65）。

**基本動作（フロー）**
1) `import effects` して副作用で全エフェクトを登録。
2) `list_effects()` を取得し、名前順で並べ替え。
3) 参照形状 `G.<REFERENCE_SHAPE>(**REFERENCE_SHAPE_PARAMS)` を生成し、セル内に収まるように初期フィット（等方スケール + セル原点基準の平行移動）。
4) 各エフェクトに対して:
   - `get_effect(name)` を解決し、`FunctionIntrospector` でメタを取得。
   - 表示用パラメータ値を決定（下記「パラメータ付与規約」）。
   - 参照形状のコピーに `fn(..., **params)` を適用してセル用 `Geometry` を得る。
   - その結果を再度セル内へフィット（等方スケール + セル中心への平行移動）。
   - ラベルは `G.text(text=name, font_size=...)` をセル上部に配置（利用不可なら省略）。
5) すべてのセル `Geometry` を `concat` で 1 つにまとめ、キャッシュ（初回だけ構築）。
6) `draw(t, cc)` はキャッシュ済み `Geometry` を毎フレーム返し、`run(...)` で描画。

**パラメータ付与規約（0..1 正規化 → 実レンジ）**
- 原則: 0..1 の単一既定値 `NORMALIZED_DEFAULT` を用いて、スカラー型はその値、ベクトルは全成分を同値で与える。
- 実レンジ決定: `__param_meta__` に `min/max/step` がある場合は `engine.ui.parameters.normalization.denormalize_scalar()` で実レンジへ変換。
- メタ欠落時: `ParameterLayoutConfig.derive_range()` でヒューリスティックに推定し、その範囲を実レンジとして使う。
- 型の扱い:
  - `type: number|float` → スカラー（denormalize）。
  - `type: int` → 整数に丸め。
  - `type: bool` → `normalized >= 0.5`。
  - `type: vec2/vec3/vector` → 全成分に同一正規化値を適用し各成分を denormalize。
  - `enum` 相当（列挙の想定）→ 先頭（index 0）を選択（現状 UI メタ未定義ならスキップ）。
- 例外: パラメータが複雑型（辞書/コールバック等）の場合は、関数デフォルトを尊重／与えない。

**レイアウトと描画**
- グリッド: `COLUMNS` で列数を決め、行数は `ceil(N_effects / COLUMNS)`。ここでの「グリッド」はレイアウトのことであり、`shapes.grid` をベース形状に使うことを意味しない。
- セル: `CELL_SIZE` から `PADDING` を引いた内枠に収まるよう等方スケールし、セル中心へ平行移動。
- 座標系: `run` の正射影では画面左上が (0,0)、Y が下向き。セル計算も同座標系で行う。
- 線幅: `LINE_THICKNESS` を固定。
- ラベル: セル上部に 1 行表示。長い名前は中点省略（`long…name`）。

**エラー処理**
- 個別エフェクトで例外が出た場合:
  - セルには「× error」とラベルだけ描画（プレビューは空）。
  - 続行して他セルの生成を継続。

**性能/安全**
- O(N) 時間/低メモリ（各エフェクト 1 回適用）。
- 頂点数が極端に多い場合は等間引きでサンプリング（例: 12,000 点上限）。
- ネットワーク不要。GPU は `ModernGL` を既存の `run` 経由で利用（追加依存なし）。

**実装タスク（チェックリスト）**
- [x] スクリプト骨格（`demo/effect_grid.py`）を追加（引数なしエントリポイント）。
- [x] エフェクト列挙と doc/signature/`__param_meta__` 取得（`FunctionIntrospector`）。
- [x] 正規化→実レンジの決定（`denormalize_scalar` とヒューリスティック）。
- [x] 参照形状生成（`api.G`）。
- [x] エフェクト適用とセル内フィット（等方スケール＋平行移動）。
- [x] ラベル生成（`G.text`、利用不可なら省略）。
- [x] 全セルを `Geometry.concat` で統合しキャッシュ。
- [x] `draw(t, cc)` で統合 Geometry を返し、`run(...)` で描画（GUI/MIDI 無効）。

**将来拡張（必要になったら）**
- 列数やベース形状を簡単に切り替える簡易 UI（引数なし方針を維持し、定数のみ編集）。
- 2 パターン比較（通常値と極値）を 2 行構成で並置。
- PNG エクスポート（Cairo/Pillow 等、依存追加は Ask-first）。
