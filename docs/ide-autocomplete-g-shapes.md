**IDE 補完強化計画: `G.s` で `sphere` を候補に出す**

目的
- `from api import G` 利用時に、エディタで `G.s` まで入力した段階で `sphere`（および他の登録シェイプ名）が補完候補に並ぶ状態を実現する。
- 主要対象: VS Code (Pylance/pyright), PyCharm。REPL/IPython でも `dir(G)` に列挙されること。

背景（現状と課題）
- 現状: `api/shape_factory.py` の `G` は `__getattr__`/`__dir__` で動的ディスパッチを提供済み。ランタイム補完（REPL 等）は十分だが、静的解析ベースの Pylance/PyCharm では候補列挙に動的属性は反映されにくい。
- 課題: 型チェッカは `__dir__` を見ない。`__getattr__` の存在だけでは候補一覧を提示できないため、静的に属性名を提示できる仕組み（型スタブや Protocol 型）が必要。

要求仕様（完了条件）
- VS Code + Pylance: エディタ上で `G.`→`s` と入力すると `sphere` を含む登録シェイプ名が候補表示される。
- PyCharm: 同様に候補表示される。
- 追加/削除されたシェイプは、開発フローに組み込んだ自動生成で型定義が同期される。

設計オプションの比較
- A. 動的 introspection 強化（`__dir__` など）
  - 長所: 実装済み、ランタイムでは有効。
  - 短所: Pylance/PyCharm の静的補完には非対応。採用済みのため追加効果は限定的。
- B. 型スタブ（.pyi）自動生成［推奨］
  - 内容: レジストリ（`shapes.registry`）から名称を列挙し、`api/__init__.pyi` に `G: _GShapes` として属性名を静的宣言。
  - 長所: Pylance/PyCharm ともに高確度で候補を提示。実装がシンプルで頑健。
  - 短所: シェイプ追加時にスタブ同期が必要（自動生成で吸収）。
- C. Protocol 型を `.py` に同居（`if TYPE_CHECKING:`）
  - 内容: `api/__init__.py` に `TYPE_CHECKING` ガード下で `class _GShapes(Protocol): sphere: Callable[..., Geometry] ...; G: _GShapes` を記述。
  - 長所: 追加ファイル不要。
  - 短所: 動的列挙を静的に埋め込む必要があり、結局生成工程が必要。`.pyi` ほど明示でない。
- D. 実体属性の自動バインド（`setattr(G, name, fn)`）
  - 長所: `dir()`/`help()` はさらに充実。
  - 短所: 静的補完の改善は限定的。現状優先度は低い。

採用方針
- 第一選択: B（型スタブ自動生成）。`api/__init__.pyi` を生成し、`G` に対して登録シェイプ名を Protocol のメソッドとして宣言（各 `generate()` のシグネチャを反映、引数はキーワード専用）。
- 併用: 既存の `__dir__` は維持（REPL 体験向上）。
- 将来拡張: シェイプ側に型ヒントが整備され次第、スタブ生成器で各 `generate()` のシグネチャを反映する高度化に対応。

実装ステップ
- 動作: `import shapes; from api.shape_registry import list_registered_shapes` で名称を列挙し、各 `Shape.generate()` のシグネチャを反映した Protocol メソッドを出力。
  ```python
  # auto-generated by scripts/gen_g_stubs.py; DO NOT EDIT
  from typing import Any, Protocol
  from engine.core.geometry import Geometry

  class _GShapes(Protocol):
      def sphere(self, *, subdivisions: float = ..., sphere_type: float = ..., **_params: Any) -> Geometry: ...
      # ... other shapes

  from .shape_factory import ShapeFactory as ShapeFactory
  G: _GShapes
  ```
- 出力先: `api/__init__.pyi`（既存 `api/__init__.py` を覆うモジュールスタブ）。
- 生成ルール: 形状名はソートして安定化。ファイル末尾に改行を入れる。

2) 開発フローへ組み込み
- pre-commit: `.pre-commit-config.yaml` に生成（gen-g-stubs）と同期テスト（test-g-stub-sync）を登録済み。
- CI: `.github/workflows/verify-stubs.yml` で生成・差分検出・同期テストを実行済み。

3) テスト（軽量）
- `tests/test_g_stub_sync.py`（ユニット）
  - `list_registered_shapes()` と `api/__init__.pyi` に記述された属性の同値性を検証（文字列比較）。
- 手動確認（VS Code/PyCharm）
  - 任意のファイルで `from api import G` → `G.` → `s` 入力で `sphere` が候補に出ることを確認。

4) ドキュメント整備
- `README.md` に「新しいシェイプを追加したら `python -m scripts.gen_g_stubs` を実行」の一文を追加。
- `docs/guides/typing.md` 新設（簡潔に型スタブ生成の背景と限界を説明）。

- 設計詳細
- シグネチャ反映: 各 `BaseShape.generate` の型ヒントを `inspect.signature`/`typing.get_type_hints` で収集し、Protocol メソッドとして `def sphere(self, *, subdivisions: float = ..., ...) -> Geometry: ...` を出力。実行時 API と整合するよう、引数はキーワード専用（`*`）。
- 依存ダミー: 生成時のみ `numba`/`fontTools` が未導入でも失敗しないようダミーモジュールを注入（スクリプト内）。実行パスには影響なし。
- 無効名の扱い: Python 識別子でないシェイプ名は `.pyi` から除外（`[A-Za-z_][A-Za-z0-9_]*`）。
- Pylance/PyCharm は `.pyi` を優先解釈するため、`api/__init__.py` の実装はそのままで良い。
- ランタイム挙動は一切変更しない（`.pyi` は型チェック専用）。

運用とリスク
- リスク: スタブの陳腐化。
  - 軽減策: 自動生成＋CI で差分検出（PR で未同期を検出）。
- リスク: 外部/動的なカスタムシェイプ（実行時登録）の補完が反映されない。
  - 対応: コア内蔵シェイプの補完を主目的とし、ユーザー拡張は現状対象外と明記。

作業見積もり
- 実装（スクリプト + 雛形生成 + 既存CIにチェック追加）: 0.5 日（完了）
- シグネチャ反映の高度化と依存のダミー化（numba/fontTools）: 0.5 日（完了）
- テスト/動作確認（VS Code/PyCharm）: 0.5 日（継続）

ロールアウト手順
- 1) スクリプト追加 → 2) 一度生成してコミット → 3) CI チェック導入 → 4) README 追記

トラブルシュート（エディタ反映）
- VS Code (Pylance): 生成後に補完が出ない場合は「Developer: Reload Window」。インデクシング完了まで待つ。
- PyCharm: 「File > Invalidate Caches / Restart」。`__init__.pyi` 更新が即時反映されない場合がある。

配布・パッケージング
- ライブラリ配布（sdist/wheel）時は `api/__init__.pyi` を必ず同梱（`MANIFEST.in: include api/__init__.pyi` など）。

既知の制約
- 型ヒント未整備の `generate()` は `Any` となる。将来の引数追加に備え、各メソッド末尾に `**_params: Any` を許容。

今後の改善案 / 実施状況
- `E.pipeline` の連鎖補完（ビルダーの Protocol 化、効果レジストリから `.pyi` 生成）。
- 対応済み: `G` メソッド docstring の自動生成（引数の簡易説明を `.pyi` の関数 docstring に埋め込み）。

付録: 生成される `api/__init__.pyi` の最小例
```python
from typing import Callable, Protocol
from engine.core.geometry import Geometry

class _GShapes(Protocol):
    sphere: Callable[..., Geometry]
    torus: Callable[..., Geometry]
    # 他、レジストリ登録済み名称が並ぶ

from .shape_factory import ShapeFactory as _SF
G: _GShapes
```
