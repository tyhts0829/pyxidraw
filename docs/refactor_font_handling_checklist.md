# フォント探索/適用 実装クリーンアップ精査チェックリスト

目的: 直近の改修で動作は安定したが、紆余曲折により複雑さ・重複・不必要な処理が混在している可能性がある。最小で読みやすく、保守しやすい実装へ整えるための精査と改善アクションを整理する。

---

## 所見（現状の気になる点）
- 二重実装/重複:
  - `src/shapes/text.py` と `src/engine/ui/hud/overlay.py` と `src/engine/ui/parameters/dpg_window.py` で、それぞれ `fonts.search_dirs` の走査ロジックが重複。
  - `.ttf/.otf/.ttc` の拡張子列挙や相対→絶対解決、再帰グロブなどが散在。
- スキャン/登録コスト:
  - HUD で `fonts.search_dirs` 配下のフォントを全登録している。大量フォント時の初期化コスト増大の可能性。
  - DPG 側は上位20件まで順次トライによりロバストだが、起動時の無駄試行を最小化できる余地あり。
- フォールバック/選択戦略:
  - DPG のスコアリングヒューリスティクスはやや過剰（Regular/Italic/Narrow 等の判定）。設定駆動 or family 名ベースで簡潔化可能。
  - Text シェイプは OS + 設定の両方を常に走査。用途により「設定のみ」「OSのみ」へ切り替え可能か検討余地。
- キャッシュ/重複除去:
  - `get_font_path_list()` はキャッシュするが、重複除去（set）や安定ソートが無い。
  - HUD 側は登録済みを避ける仕組みが無い（`pyglet.font.add_file` の多重登録は基本無害だが無駄）。
- 名前解決の明確化:
  - HUD では family 名（例: "HackGen Console NF"）の指定が必要であることをコード/ドキュメントに明記できる。
  - DPG はファイル単位指定（family 名ではなくファイルパス）であることを明示。
- ログ/デバッグ:
  - 現状は print/警告を抑制済み。再調査時にのみ有効化できる環境変数スイッチ（例: `PXD_DEBUG_FONTS=1`）があると便利。

---

## 改善アクション（提案）
- [x] 共通ユーティリティの導入
  - `util/fonts.py`（新規）に、以下の関数を集約:
    - [x] `resolve_search_dirs(cfg_dirs: list[str|Path]) -> list[Path]`（相対/`~`/env 展開 + ルート解決）
    - [x] `glob_font_files(dirs: list[Path], exts=(".ttf",".otf",".ttc")) -> list[Path]`（重複除去 + 安定ソート）
  - 既存の3箇所から上記を呼ぶようにして重複を排除。
- [x] HUD の登録最適化
  - [x] `fonts.search_dirs` から「要求 family 名に部分一致するファイル」のみを優先登録し、フルスキャンはオプション化（`hud.load_all_fonts: false` 既定）。
  - [ ] 既に登録済みパスはスキップ（簡易 set キャッシュ）。
- [x] DPG の選択ロジック簡素化
  - [x] まず要求名で厳密/部分一致 → 失敗時のみ最小限のフォールバック（例: 最初の `*.ttf`）。
  - [x] 可変フォント/GX/Italic/Narrow 等のヒューリスティクスを削減（不要なら削除）。
  - [x] 上位20件トライは維持する場合でも、要求名一致候補のみに限定。
- [x] Text シェイプの探索制御
  - [x] 設定で「OS 走査を無効化」できるフラグ（例: `fonts.include_os: true`）。テスト用途や軽量化に有用。
  - [x] 取得リストの重複除去 + 安定ソート。
- [x] ドキュメント整備
  - [x] `architecture.md` に family 名（HUD）とファイルパス指定（DPG）の違いを明示。
  - [x] `configs/default.yaml` に `fonts.search_dirs` の注意（ttcの扱い/DPGはttf推奨）を追記。
- [x] デバッグスイッチ
  - [x] `PXD_DEBUG_FONTS=1` 時のみ詳細ログ（探索件数/採用/失敗理由）を出す仕組みを `util/fonts.py` に集約。

---

## 影響範囲とリスク
- 影響: フォント探索/登録に関わる3箇所（Text/HUD/DPG）。
- リスク: 既存挙動の微妙な順序依存が変化する可能性 → 安定ソートと明示優先順位で緩和。
- パフォーマンス: 初期化時間が改善（無駄試行/全登録の削減）する見込み。

---

## 実施手順（段階的）
1) 共通ユーティリティ作成（既存コードのロジック移設・参照先差し替えのみ）
2) HUD の全登録→選択的登録へ（フラグで切替、既定は安全側）
3) DPG のフォールバック整理（要求一致→最小限フォールバック）
4) Text の OS 走査をオプトアウト可能に（既定は従来どおり）
5) ドキュメント反映 + 最小テスト更新

---

このチェックリストに沿ってクリーンアップを進めてもよいですか？ご承認後、各項目を段階的に実装し、完了済みにチェックを入れていきます。
