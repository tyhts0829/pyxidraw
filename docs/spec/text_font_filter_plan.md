# Text シェイプ用フォントフィルター計画

## 目的・ゴール

- Parameter GUI の `font` プルダウンから基本的なグリフを欠くフォントを除外し、選びやすさと信頼性を上げる。
- `tools/` にフィルタリングスクリプトを追加し、その出力を Text シェイプの候補生成に利用する仕組みを整える。

## 現状メモ

- `src/shapes/text._font_choices()` は `config fonts.search_dirs` のみを再帰列挙し、ファイル stem でユニーク化しているだけ（OS フォントは含めず、グリフ検証なし）。
- TextRenderer は `fonts.include_os` に応じて OS フォントも解決するが、GUI の候補には反映されない。
- 収集ディレクトリによっては ASCII の基本グリフが欠落したファイルも含まれ、プルダウンが過多で実用的でない。

## 改善方針（案）

- `tools/` に CLI スクリプトを置き、指定ディレクトリ（config 由来 + 任意で OS フォント）を走査して「必須グリフを全て含むフォント」だけを抽出する。
- TTC を含む複数フェイスを検査し、利用可能な `font_index` を保持する。読み込み失敗時はスキップしログに残す。
- 出力を JSON などの機械可読な一覧にまとめ（ファミリ名・パス・font_index・ソース種別を想定）、ソートして決定論的に生成する。`--dry-run` で書き込み無しの確認も可能にする。最初に見つかった usable face を採用し、その `font_index` をヒントとして保存。
- Text シェイプの `_font_choices` は生成済み出力を優先し、無い場合のみ従来の列挙にフォールバックする。`font_index=0` が指定された場合はヒントがあればそれを優先適用する。
- スクリプトの使い方と出力ファイルパスをドキュメント化し、手動実行を基本とする（CI での自動実行は想定しない）。

## 実装タスク チェックリスト（ドラフト）

- [x] 必須グリフセット・出力パス・デフォルト検索範囲（config search_dirs と OS をどう扱うか）を決定し、仕様を固定する。
- [x] `tools/filter_fonts.py` の CLI 骨子を用意（argparse、`--search-dir`/`--include-os`/`--output`/`--required-glyphs`/`--dry-run` など）。安全側の既定値を設定。
- [x] フォント検証ロジックを実装（fontTools で face を開き、指定コードポイントが `cmap` に揃っているか判定；読み込み失敗は握りつぶさずログへ）。
- [x] 抽出結果の整形・出力（決定論的なソートと重複排除、family 表記と表示名の決定ルールを整理、JSON 書き出しと dry-run プレビューを実装）。
- [x] `src/shapes/text._font_choices` を出力ファイル優先で読む形に変更し、欠損時は既存列挙へフォールバックする。データ構造が変わる場合は適宜ユーティリティを追加。
- [x] ドキュメント更新（本計画の反映・スクリプトの実行手順・出力の配置と `.gitignore` 方針、必要なら `configs/default.yaml` のコメント追記）。
- [ ] 確認フロー（小さなフォントセットでスクリプトを実行し、プルダウンに絞り込まれた候補が出ることを手動確認；可能ならユニットテストで最低限の検証を追加）。

## 要確認事項（ご相談 → 方針反映）

- [x] 必須グリフの範囲はどこまで要求するか？
  - 大文字 A〜Z か小文字 a〜z のどちらかを含めば採用（どちらか片方で可）。
- [x] OS フォントを候補に含めるべきか？含める場合のデフォルト挙動
  - 含める。デフォルトは `include_os=true` 相当で扱う。
- [x] 出力ファイルの形式・パスをどうするか？
  - `data/fonts/usable_fonts.json` に出力（git 管理前提）。
- [x] プルダウンの表示名は何を採用するか？
  - 任せる（実装側で family/style 情報を用いて決定）。
- [x] スクリプト実行のトリガーは手動のみで良いか？
  - 手動のみ（補助タスク追加なし）。
