# explode エフェクト 仕様変更 計画チェックリスト

対象: `src/effects/explode.py`
目的: 線の長さを変えずに、中心から外側へ頂点（線分）を放射状に移動させる。結果として、既存の連続線は線分単位に分断される。Z も含め XYZ 方向へ移動。

---

## 仕様（合意したいポイント）
- 入力は `Geometry`（ポリライン集合）。
- 出力は「各線分を独立要素として扱う Geometry」。
  - 連続線は線分ごとに分断（各線分=2頂点のポリライン）される。
  - 1 点だけの線は 1 点ポリラインとして残す。
- 変形は「線分の剛体平行移動」のみで長さ不変。
  - 各線分の中点を基準に、全体の重心（あるいは全頂点平均）から外側へ向かう方向ベクトルを正規化し、`factor[mm]` だけ平行移動する（XYZ 方向）。
  - Z も移動（XY のみではない）。
- パラメータ:
  - `factor: float` mm 単位。RangeHint は 0–50（現状維持／クランプは表示のみ）。
- 空ジオメトリは no-op（コピーを返す）。
- 例外/不定ケース:
  - 重心と線分中点が完全一致する場合（方向ベクトルの長さ 0）は移動量 0 とする。

---

## 実装方針（アルゴリズム）
- `coords, offsets = g.as_arrays(copy=False)` を取得。
- 全体重心 `center = coords.mean(axis=0)` を算出（XYZ で算出）。
- 新規配列を構築:
  - 総線分数 `S = sum(max(0, (len_i - 1)))` を前取り計算し、`out_coords` を shape `(2S + P_single, 3)` で確保。`out_offsets` は長さ `S + P_single + 1`。
  - 各ポリライン i（インデックス範囲 `s:e`）について:
    - `e - s >= 2` のとき、各連続ペア `(p0, p1)` を 1 線分とし、中点 `m = (p0+p1)/2` を計算。
      - 方向 `d = (m - center)` を正規化して `delta = unit(d) * factor`（XYZ）。
      - `p0+delta`, `p1+delta` を `out_coords` に書き込み、`out_offsets` に 2 点ポリラインとして登録。
    - `e - s == 1` のとき（単一点）、方向 `d = (p0 - center)` で同様に `delta` を求め、`p0+delta` を 1 点ポリラインとして登録。
- `Geometry(out_coords.astype(np.float32), out_offsets.astype(np.int32))` を返す。
- ドキュストリングを新挙動に合わせて更新（線分分断・長さ不変を明記）。
- `__param_meta__` は現状維持（`{"factor": {"type": "number", "min": 0.0, "max": 50.0}}`）。

---

## 変更タスク（チェックリスト）
- [x] 仕様最終確認（要確認事項への回答を反映）
- [x] `src/effects/explode.py` 実装更新（線分単位の剛体移動）
- [x] ドキュストリング更新（新仕様の要点を記述）
- [x] 局所スタイル/型チェックの実行（編集ファイル優先）
      - `ruff check --fix src/effects/explode.py`
      - `black src/effects/explode.py && isort src/effects/explode.py`
      - `mypy src/effects/explode.py`
- [x] 簡易動作確認（スモーク）
      - `pytest -q -m smoke` もしくは `pytest -q -k explode`（該当テストがあれば）
- [x] 公開 API 影響の確認（シグネチャ変更なし→スタブ再生成は不要）
      - 必要なら `python -m tools.gen_g_stubs` で差分確認のみ（コミットは変更がある場合に限る）
- [x] `architecture.md` 影響の確認（該当記述なしなら変更不要）

---

## 決定事項（確認結果の反映）
1) 平行移動の基準点: 線分の「中点」。
2) Z 軸の扱い: Z も移動する（XYZ 方向）。
3) 単一点ポリライン: 1 点のまま移動。
4) 方向ゼロ（重心一致）の扱い: 移動量 0。

---

## 受け入れ基準（Done の定義）
- 実装が「線分長は変化しない」「全連続線が分断される」ことを満たす。
- 編集ファイルに対する `ruff/black/isort/mypy` が成功。
- スモークテストが通る（存在する場合）。
- ドキュメント（ドキュストリング）が新仕様を記述。

---

## リスクと互換性
- 既存の explode の挙動（頂点ごとの放射移動）から破壊的に変わるため、見た目が変化する。
- 頂点数が「線分×2」へ増えるため、描画コストがやや増える（ただし O(N) で実装）。

---

## 参考（テスト観点のメモ）
- 任意ジオメトリで、前後の各線分長 `||p1-p0||` が一致することを数値確認。
- 連続線入力で `len(out)`（ポリライン本数）が「総線分数 + 単一点数」になっていること。
- `factor=0` で形状が（分断以外）平行移動されないこと。

---

この計画で問題なければ実装に着手します。修正・追加のご要望があればお知らせください。
