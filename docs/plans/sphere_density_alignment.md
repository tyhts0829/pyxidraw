# Sphere 線密度アライン計画（段階実施・目視承認）

対象: `src/shapes/sphere.py`

目的: `sphere_type=2`（icosphere）に対して他タイプ（latlon/zigzag/rings）の線密度が低い。厳密な数値一致は求めず、タイプごとに順を追って「見かけの密度」を引き上げ、最終判断は目視で行う。

前提: icosphere（type 2）は現状のまま基準とし、他タイプのみ手当てする。

---

## 現状メモ（参照）
- latlon: `src/shapes/sphere.py:14` `_sphere_latlon`
- zigzag: `src/shapes/sphere.py:66` `_sphere_zigzag`
- icosphere: `src/shapes/sphere.py:112` `_sphere_icosphere`
- rings: `src/shapes/sphere.py:223` `_sphere_rings`

各タイプの密度差の主因は、分割数の固定/偏りと、交差方向の少なさ（特に zigzag）にある。

---

## 進め方（フェーズ順）
段階的に 1 タイプずつ改善し、その都度「目視 OK」をもらう。数値指標は参考値のみ（確認の補助）。

- フェーズ0（準備）
  - 参考用ユーティリティを用意（任意）:
    - `resample_polyline_equal_arc(vertices, max_len)` 等弧長リサンプル
    - `densify_vertices_list(lines, max_len)` 一括デンシファイ
    - 軽い指標出力（総セグメント数、総線分長）

- フェーズ1（latlon; type 0）
  - 半径に応じたリング分割（円周から `segments_at_lat = ceil(2πr / L)`) へ変更
  - 経度方向の本数も `L` に応じてスケール（過疎/過密を緩和）
  - 生成ポリラインをリサンプルで均一化（必要なら）
  - 確認: 目視（あなたのチェック）。参考: セグメント数/線分長ログ

- フェーズ2（rings; type 3）
  - 各リング半径に応じて分割数を可変化（固定 64 を撤廃）
  - X/Y/Z いずれのリング群も同ルールで分割、必要ならリサンプル
  - 確認: 目視（あなたのチェック）。参考: セグメント数/線分長ログ

- フェーズ3（zigzag; type 1）
  - 位相をずらした複数ストランド化（2–6 本を想定）
  - 各ストランドを等弧長で分割し、全体の交差密度を引き上げる
  - 見た目の「zigzag」らしさは維持（過度に格子化しない）
  - 確認: 目視（あなたのチェック）。参考: セグメント数/線分長ログ

- フェーズ4（微調整・オプション）
  - 微調整用パラメータ `density_scale: float = 1.0` の追加（必要なら）
  - `__param_meta__` に RangeHint（例: 0.5–2.0, step=0.05）

---

## チェックリスト（段階実施・各フェーズごと承認）

- [ ] P0: 参考ユーティリティ（任意）
  - [ ] 等弧長リサンプル/デンシファイを実装（必要な最小範囲で）
  - [ ] 参考指標のログ出力（総セグメント数/線分長）

- [ ] P1: latlon 改善（type 0）
  - [x] 半径連動のリング分割導入
  - [x] 経度方向の本数スケーリング
  - [ ] 必要に応じてリサンプル適用
  - [ ] 目視確認（あなた）→ OK で次へ

備考: `equator_segments = 64*(subdivisions+1)` を基準とし、
- 経度線本数 = `equator_segments`
- 子サンプリング（極→極） = `ring_count = max(8, equator_segments//2)`
- 各緯度リングの周方向分割 = `ceil((2πr)/L)`（`L = 2πR/equator_segments`, `r=sin(lat)*R`, `R=0.5`）

追加調整（最小 subdivisions のみ）
- 赤道分割の下限を 160 に引き上げ（周方向のカクつき緩和）
- 各緯度リングの最低分割を 24 に設定（周方向の見た目改善）
 - 表示する緯度リングの本数を約 1/4 に削減（描画負荷を抑えつつ、周方向の滑らかさを優先）

- [ ] P2: rings 改善（type 3）
- [x] 半径連動の分割数（固定 64 撤廃）
- [x] X/Y/Z すべてに適用、必要に応じてリサンプル
- [ ] 目視確認（あなた）→ OK で次へ

追加調整
- subdivisions が大きい場合（>=4）はリング本数を概ね倍増させ、密度感を向上

- [ ] P3: zigzag 改善（type 1）
  - [x] 複数ストランド化（2–4 本で調整）
  - [ ] 各ストランドの等弧長分割（必要なら追加）
  - [ ] 目視確認（あなた）→ OK で次へ

- [ ] P4: 微調整/オプション
  - [ ] `density_scale` 追加の是非を最終判断
  - [ ] `__param_meta__` 更新（追加した場合）
  - [ ] ドキュメント同期（必要時）

---

## 注意と境界
- 厳密な数値一致は目指さない。目視で十分な密度感が得られれば完了。
- icosphere（type 2）は変更しない。
- 既存 API は維持。重い依存は追加しない。
- rings は各リング半径に応じて周方向分割を決定。最小 subdiv のみ下限分割を引き上げて滑らかさ確保。
 - zigzag は points_per_rotation を控えめにし、ストランド数で密度を上げる（高 subdiv でも過度に重くしない）。

---

## 連絡事項（随時）
- フェーズごとにスクリーンショット/ログを共有可能（希望があれば）。
- 既定のフェーズ順（latlon → rings → zigzag）で進める。順序変更の希望があれば指示してください。
