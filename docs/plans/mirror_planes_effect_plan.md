# effect: mirror 設計・実装計画

本ドキュメントは、対象面ミラーリング（mirror_planes）effect の実装に向けた計画書。実装前の合意形成と、進行時のチェックリストとして用いる。

プロジェクト仕様適合:
- 本プロジェクトの線群は `coords: (N,3)`, `offsets: (M+1,)` の 3D 座標系（参照: `src/engine/core/geometry.py`）。
- 本 effect は 3D 入力を前提とし、鏡映は XY 平面内の位置に対して行い、`z` は不変とする。

## 背景と目的

- 線群（3D `Geometry` のポリライン群）を、指定した中心 `(cx, cy)` を通る対称平面に対して鏡映し、所定の領域へ複製する。
- v0 の対象は `n_mirror ∈ {1, 2}` のみ（一般化 `n_mirror>=3` は後続拡張）。
- ソース領域外に元から存在していた線は削除し、ソース領域内（クリップ後）の線からのみ全域を生成する。

## 機能要件（要約）

- `n_mirror = 1`: 平面 `x = cx` を基準に、指定側（ソース）から反対側へ鏡映。反対側に元々ある線は削除。`z` は不変。
- `n_mirror = 2`: 平面 `x = cx`, `y = cy` を基準に、指定象限のみをソースとし、残り 3 象限へ鏡映。元々の他象限の線は削除。`z` は不変。
- 平面の中心座標 `(cx, cy)` は引数で指定可能（`z` は無関与）。

## 仕様詳細

### ソース領域の定義（v0）

- クリップ方針: 入力ポリラインを「ソース領域でクリップ」して、ソース内の部分線のみを採用する（重心判定ではなくクリップ）。
- `n=1`: 半空間 `x >= cx` もしくは `x <= cx`（後述 `source_side`）でクリップ。
- `n=2`: 直交する 2 半空間（`x` と `y`）の共通部分でクリップ（指定側の象限）。
- クリップは 3D 直線分に対し、平面 `x=cx`, `y=cy` の交点を用いて行う。`z` は不変。

### 鏡映平面と反射

- 鏡映は XY 内の座標変換で実装（`z` はそのまま）。
  - `x=cx` に関する反射: `x' = 2*cx - x`, `y' = y`, `z' = z`。
  - `y=cy` に関する反射: `x' = x`, `y' = 2*cy - y`, `z' = z`。
  - `n=2` は上記の組合せ（x のみ / y のみ / x+y）。

### 削除規則・境界

- ソース領域外にある「元の」線は削除対象。生成はソースでクリップされた線からのみ行う。
- 境界上の線は一度だけ保持。比較・交点計算・重複検出に許容誤差 `eps=1e-6` を用いる。

### 拡張余地

- v1 以降で `n_mirror>=3` の放射状ミラーや任意角の対称軸への拡張を検討（任意角回転パラメータの導入など）。

## API / パラメータ

- 名称（確定）: `mirror`
- シグネチャ（関数または Effect クラスの実行パラメータ）：
  - `n_mirror: int`（許容: 1 または 2, default=1）
  - `cx: float`（default=0.0, step=0.1, range≈[-10000, 10000]）
  - `cy: float`（default=0.0, step=0.1, range≈[-10000, 10000]）
  - `source_side: int | Sequence[int]`（default=1）
    - 値の意味: `+1`=正側（`x>=cx` または `y>=cy`）、`-1`=負側（`x<=cx` または `y<=cy`）。
    - 指定方法: 長さ `n_mirror` の list/tuple で各対称平面の側を指定。長さ不足時は循環（cycle）。
      `int` 単体を与えた場合はすべての対称平面に同じ値を適用。
    - `n=1` では X 平面の側を、`n=2` では `[X側, Y側]` の順で解釈。
  - `include_boundary: bool`（default=True）
- 量子化ポリシー：`__param_meta__['step']` を設定（float のみ量子化／int・bool はそのまま）。未指定時の既定 `1e-6`（`PXD_PIPELINE_QUANT_STEP` で上書き可）。ベクトルは成分ごと・不足は末尾 step を補完。

`__param_meta__`（案）:

```python
__param_meta__ = {
    'n_mirror': {'min': 1, 'max': 2, 'step': 1},
    'cx': {'min': -10000.0, 'max': 10000.0, 'step': 0.1},
    'cy': {'min': -10000.0, 'max': 10000.0, 'step': 0.1},
}
```

## 実装方針

### ファイル/登録

- 追加: `src/effects/mirror.py`
- 登録: `src/effects/registry.py` に `mirror` を登録（実体は `@effect(name="mirror")`）

### コアアルゴリズム（v0）

1) 入力 `Geometry` の各ポリラインを、ソース半空間（n=1）またはソース象限（n=2）でクリップ。
   - 半空間クリップ: `x ◇ cx` または `y ◇ cy`（`◇` は `>=`/`<=`。`source_side` により決定）。
   - クリップ結果が空の線は破棄。
2) クリップ後のソース線から、鏡映平面（n=1: x, n=2: x と y）に関する反射を適用して複製。
   - n=1: x 反射の 1 セットを追加。
   - n=2: x のみ / y のみ / x+y の 3 セットを追加。
3) 元の「ソース外に存在した線」は 1) の時点で除去済みとなる（設計仕様を満たす）。
4) 重複パスを `eps=1e-6` で正規化・除去（頂点量子化のハッシュで高速化）。

### 設計留意

- 計算量: O(M·n)。ソースクリップで M を抑制。
- 数値安定性: 比較・交点・重複検出に `eps=1e-6` を用いる。
- Z 座標は不変（XY 上の対称操作）。
- GUI: 明示引数 > GUI > 既定値（現行仕様に準拠）。

## テスト計画

- n=1 基本: `cx=0`、ソース側（例: `x>=0`）でクリップし、反対側へ鏡映。反対側に元々あった線は消える。
- n=2 基本: `cx=0, cy=0`、ソース象限（例: 第 1 象限）でクリップし、残り 3 象限へ鏡映。他象限の元線は消える。
- source_side の組合せ: `(+1,-1)` 等の指定でソース象限が切り替わること。
- 境界と重複: 境界上の線は一度のみ出現。重複除去が働くこと。
- Z 不変: 入力の `z` が出力で保存されること。
- ファイル: `tests/effects/test_mirror_planes.py`

## ドキュメント/同期

- `src/effects/mirror.py` に日本語 docstring（What/How）。
- `architecture.md` に effect 追加の概要と数式・削除規則・境界ポリシーを追記。
- レジストリ更新の参照箇所（`effects/__init__.py` インポート追加済み）を明記。

## 決定事項（確認済み）

- v0 は `n_mirror ∈ {1,2}` のみ実装。`n>=3` の一般化は後続で拡張。
- `source_side` を追加。長さ `n_mirror` の list/tuple または `int` 単体（循環/一括適用）。値は `+1`/`-1`。
- ソース外へはみ出す線は「クリップして扱う」。
- 重複判定・境界許容 `eps = 1e-6`。

## 作業チェックリスト（進行管理）

- [x] 仕様確定（本書の決定事項反映）
- [x] API/パラメータ定義（`__param_meta__` 含む）
- [x] クリップ実装（x 半空間 / y 半空間 / 直交クリップ）
- [x] 反射実装（x 反射 / y 反射 / 合成）
- [x] 重複除去（量子化ハッシュ）
- [x] `src/effects/registry.py` 登録（`effects/__init__.py` インポート追加）
- [x] 単体テスト作成（`tests/effects/test_mirror_planes.py`）
- [x] 変更ファイルに対する ruff/black/isort/mypy/pytest 緑化（対象限定）
- [ ] `architecture.md` 更新
- [ ] README/AGENTS 整合確認（必要に応じて追記）

## 完了条件（DoD）

- 変更ファイルに対して `ruff/mypy/pytest` 成功（編集ファイル優先の高速ループ）。
- effect が registry 経由で利用可能。公開 API の破壊は行わない。
- スタブ同期が必要な変更がないこと、またはスタブ更新とテスト緑化が完了していること。
- `architecture.md` と実装が同期し、差分がないこと。
