# clip.py リファクタリング計画（チェックリスト）

目的: 可読性と保守性の改善、軽微な冗長排除を行い、既存仕様（Shapely あり/なし両経路、キャッシュ、投影フォールバック、偶奇規則）の振る舞いを維持する。

影響範囲: `src/effects/clip.py`（実装のみ）。公開 API 変更なし。ドキュメント/テストは必要に応じ最小更新。

前提: AGENTS.md の方針に従い、変更はシンプル・明確さ優先。編集ファイル限定で ruff/black/isort/mypy/pytest を通す（対象限定）。

---

- [ ] 未使用・冗長コードの整理（安全な削除）
  - [ ] `all_offsets` と関連ロジックの削除（最終的に `offs` 再計算で代替済み）
  - [ ] `coord_shift` の削除（未使用）
  - [ ] フォールバック内 `xs` の削除（コメント含め未使用）
  - [ ] `_segment_intersections_with_polygon_edges` 戻り値 `(t, x)` → `(t)` に簡素化（呼び出し側未使用の `x` を除去）

- [ ] 2D クローズ処理の簡素化
  - [ ] `_prepare_projection_mask` の 2D 環での閉路処理を 3D 経由せず 2D 専用ヘルパへ（意図を明確化）

- [ ] import の重複/ばらつき整理
  - [ ] `import os as _os` の重複インポートを整理（先頭へ集約）

- [ ] 仕様コメント/注記の微修正（挙動は変更しない）
  - [ ] on-edge 取り扱い（Shapely 経路とフォールバックの差異があり得る）を短い注記として docstring に追記
  - [ ] モード安定化（`_MODE_PIN`）の方針注記強化（初回モードのピン挙動）

- [ ] 軽微な型/名前の一貫性
  - [ ] 戻り値/引数の `np.ndarray` 型注釈の確認と不足時の補完（mypy 静的エラーが出ない範囲）

---

オプション（要確認）

- [ ] `_MODE_PIN` の安定化方針見直し（必要なら）
  - 案A: planar が一度でも成立したら pin を `planar` に昇格
  - 案B: pin に TTL を付与して定期的に再評価
  - 案C: UI/引数で pin を無効化できるトグルを設ける（既定は現状維持）

- [ ] Shapely 無し経路の on-edge 近傍の数値安定を微調整（ε の一元化など）

---

検証（変更ファイル限定）

- [ ] ruff/black/isort を `src/effects/clip.py` に対して実行
- [ ] mypy を `src/effects/clip.py` に対して実行
- [ ] 代表テスト（smoke/対象ファイル）を実行
  - 例: `pytest -q -k clip`（テストがある場合）

---

メモ/質問（確認したい点）

- [ ] `_MODE_PIN` の方針は現状の「初回決定を優先」で問題ないか？（要件次第で上記オプションのどれかに変更可）
- [ ] Shapely 有無での on-edge 差異について、現状仕様として明記する方向でよいか？（動作は維持）

承認いただければ、上記チェックリストに沿って小さなコミットに分けて実施し、完了項目にチェックを入れていきます。

