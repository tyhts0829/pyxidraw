# texts.py の text × fill でドーナツ型文字の穴が塗りつぶされる問題 — 改善計画

- 対象: `texts.py:25`（`E.pipeline.fill(...)` を適用）、`src/shapes/text.py:145`（テキスト形状生成）、`src/effects/fill.py:178`（塗りつぶし実装）
- 症状: 'o' や 'a' 等の内側に穴を持つグリフでも、`fill` 適用時に穴が塗りつぶされてしまう。
- 推定原因: グリフ外周と内周（穴）が別ポリラインとして `Geometry` に積まれており、`fill` が「単一ポリゴンごと」にスキャンライン生成しているため、内周も独立した“塗りつぶし対象”として扱われる（偶奇規則の考慮がない）。

## 対応方針（最小で正しい挙動）

- Fill のスキャンライン決定を「複数ポリラインの偶奇規則（even-odd rule）」で行う。
  - 入力が同一平面上の複数輪郭（テキストの外周＋内周）であっても、同一スキャンライン上の交点を全輪郭から収集し、x を昇順に並べて偶奇で塗る/塗らないを切り替える。
  - これにより外周内側は塗られ、穴（内周）内側は塗られない。
- API/データモデル変更は行わず、`src/effects/fill.py` 内のアルゴリズムを拡張する。
- 2D（Z=0 または共平面）では偶奇統合ルートを使い、非共平面や 3D は既存の per-polygon ルートにフォールバック（安全・段階導入）。

## 実装タスク（チェックリスト）

- [ ] 現状の流れ確認と再現
  - [ ] `texts.py:25` のデモで 'o', 'a' の穴が塗られることを確認
  - [ ] `src/shapes/text.py:145` 付近で、グリフが複数ポリライン（外周/内周）として `Geometry.from_lines` へ積まれていることを確認
  - [ ] `src/effects/fill.py:198` の per-polygon ループで穴も独立に塗っていることを確認

- [x] スキャンライン統合（偶奇）実装（lines/cross）
  - [x] 2D 一括処理関数 ` _generate_line_fill_evenodd_multi(polylines_3d, density, angle)` を追加
    - [ ] 全ポリラインを `transform_to_xy_plane` で XY に射影（テキストは共平面）
    - [ ] 角度回転（`angle_rad`）は“輪郭全体”に一括適用し、その後スキャン
    - [ ] y グリッドを決定し、各 y に対し「全ポリラインのエッジ」から交点 x を収集
    - [ ] x を昇順に並べ、`(x0,x1),(x2,x3),...` の奇数区間を「塗る」として線分生成
    - [ ] 生成した 2D 線分を 3D に戻し、元の姿勢へ `transform_back`
  - [x] `cross` は `even-odd` ベースの lines を 2 方向で合成

- [x] ドットパターン（dots）の偶奇対応
  - [x] 既存 `find_dots_in_polygon(...)` 相当の「点が多角形群に対して偶奇内か」を判定する `point_in_polylines_evenodd(...)` を追加
  - [ ] グリッド点のうち偶奇で内側のみを採用して十字点線を生成

- [x] フォールバックと境界条件
  - [x] 入力が明確に共平面でない場合（Z 分散で判定）、既存の per-polygon ルートを使用
  - [x] 交点が重複/接線（水平/頂点上）となるケースの数値安定化（閾値でフィルタ）

- [x] 統合と切替
  - [ ] `src/effects/fill.py:178` のメインループを拡張し、共平面グループでは `even-odd` の一括ルートに切替
  - [ ] 既存のアウトラインは引き続き出力（塗り＋輪郭）

- [ ] 性能（初期版 → 必要に応じて最適化）
  - [ ] 初期は Python ループ＋Numba 小関数の併用で実装（依存追加なし）
  - [ ] 密度大（MAX_FILL_LINES）時の時間計測とホットスポット確認
  - [ ] 必要時のみ Numba 化/ベクトル化を追加

## テスト計画（必須）

- [ ] 単体（smoke）
  - [ ] 'o', 'a', 'e', 'B', '8' の各グリフで、中心付近のスキャンラインにおいて「2 本以上の分割された塗り線」が得られる（穴が空く）ことを検証
  - [ ] `angle_rad=0` と `angle_rad=pi/4` の双方で成立
- [ ] 統合
  - [ ] `texts.py` のデモ（`texts.py:25`）を angle/density 変化で目視/幾何確認
- [ ] 回帰
  - [ ] 穴を持たない文字（'I','L','S' 等）で従来と同様の塗り結果になること
  - [ ] `dots` モードで穴内に十字点が生成されないこと

## 受け入れ条件（Definition of Done）

- [ ] 'o' や 'a' で穴に塗り線/点が入らない（偶奇規則に整合）
- [ ] 既存の 2D 形状（穴なし）で結果が変わらない（または改善のみ）
- [ ] API 変更なし、依存追加なし、`ruff/mypy/pytest -q -m smoke` 緑
- [ ] 必要に応じて `architecture.md` に「fill は偶奇規則で多輪郭を扱う」旨を追記

## 変更範囲と影響

- 変更ファイル想定: `src/effects/fill.py` のみ（アルゴリズム拡張）。
- `src/shapes/text.py` は現状のポリライン出力のまま（変更不要）。
- `Geometry` のデータモデル変更なし。

## リスクと回避策

- 交点の数値安定性（頂点/水平エッジでの二重カウント）
  - → イプシロンしきい値と半開区間の扱い統一で回避
- 高密度時の計算コスト増
  - → 初期は素直な実装＋必要時のみ Numba 最適化
- 3D/非共平面入力
  - → 共平面判定で per-polygon にフォールバックし安全運用

## 相談事項 / 決めたい点

- `cross/dots` も偶奇規則に統一で問題ないか（現仕様からのズレなし）
- 輪郭線（元のポリライン）を結果に含め続けるかの方針
- 共平面の判定閾値（Z 分散 or 法線角度）

---

この計画で実装に進めてよいか確認してください。OK ならタスクを順に実行し、進捗は本ファイルにチェックを付けて更新します。
