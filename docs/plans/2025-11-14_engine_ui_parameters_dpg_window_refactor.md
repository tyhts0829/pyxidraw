どこで: `src/engine/ui/parameters/dpg_window.py`（Parameter GUI の Dear PyGui 実装）
何を: パラメータウィンドウの責務分離・依存関係整理・テストしやすさ向上を目的とした段階的リファクタリング
なぜ: 1,600 行超の単一クラス/モジュールに UI 構築、フォント探索、テーマ設定、ストア購読、ドライバスレッド管理など多責務が集中しており、変更コスト・把握コストが高いため

# 現状のざっくり把握

- `ParameterWindowBase` / `ParameterWindow` が同一モジュール内に定義されている
- `ParameterWindow` が以下の責務をすべて直接持っている
  - Dear PyGui コンテキスト/ビューポートのライフサイクル管理（`create_context`/`destroy_context`/`show_viewport` など）
  - ParameterStore の購読と UI への反映（`_on_store_change` と `sync_display_from_store`）
  - ParameterDescriptor 群からのウィジェット構築（グルーピング、セクション/テーブル、ウィジェット追加）
  - フォント探索とフォント登録（設定ファイル・フォント検索ディレクトリ・`util.fonts`）
  - テーマ（色/スタイル）の構築・キャッシュ（カテゴリ別テーマ）
  - バックグラウンドでの Dear PyGui ドライバスレッド（`_start_driver` / `_stop_driver`）
- HUD 連携や `runner.*` 系パラメータ（例: `runner.show_hud`）も本モジュールの UI に含まれており、
  他モジュールの仕様変更の影響を受けやすい

# リファクタリングのゴール

- 責務ごとにクラス/関数/モジュールレベルの分割を行い、`ParameterWindow` の役割を「構成要素の組み立てと公開インタフェース」に絞る
- 「Dear PyGui の生 API 呼び出し」「ParameterStore との橋渡し」「フォント/テーマ設定」を明確に分離し、テスト対象を限定しやすくする
- `run_sketch` や Parameter GUI 周辺の仕様変更（例: `runner.show_hud` 挙動）に追従しやすい構造にする
- 既存の公開 API（`ParameterWindowBase`/`ParameterWindow` のコンストラクタ・メソッドシグネチャ）は可能な範囲で維持する

# 作業ステップ（チェックリスト）

## 1. 現状構造の整理

- [ ] `dpg_window.py` 内のクラス/関数/主要なプライベートメソッドを一覧化し、ざっくり役割をメモする
- [ ] 「ウィンドウライフサイクル」「フォント/テーマ」「レイアウト構築」「ストア購読/同期」「ドライバスレッド」の各責務ごとに関数/メソッドをグルーピングする
- [ ] 依存関係（`ParameterStore` / `ParameterDescriptor` / Dear PyGui / `util.*` / 設定ファイル）の方向を確認する
- [ ] 既存テスト（`tests/ui/parameters/test_dpg_mount_smoke.py` など）で `dpg_window` に直接依存している箇所を洗い出す

## 2. インタフェースの最小化・明確化

- [ ] `ParameterWindowBase` と `ParameterWindow` で「外部から呼ばれるメソッド」を列挙し、公開インタフェースとして固定する
- [ ] 将来のテスト容易性のために、「Dear PyGui 依存を持たない抽象インタフェース」にできる部分がないか検討する
- [ ] 既存の使用箇所（`api.sketch_runner.params` など）で `ParameterWindow` のどのメソッド/属性に依存しているかを確認する

## 3. フォント/テーマ関連の分離

- [ ] フォント探索と登録ロジック（`_setup_fonts` および関連ヘルパ）を一つの小さな責務とみなし、クラス外（または専用クラス）に切り出す案を作成する
- [ ] テーマ構築（カテゴリ別テーマや色設定）のロジックを抽出し、「入力: 設定/カテゴリ → 出力: テーマID群」の純粋関数に近づけられるか検討する
- [ ] 切り出し後も API 的には `ParameterWindow` のコンストラクタ内部でそれらを呼び出すだけにできる形を目指す

## 4. レイアウト構築ロジックの分割

- [ ] Descriptor 群から DPG ウィジェットツリーを構築する処理（テーブル、セクション、ウィジェット追加）を担当する小さなビルダ関数/クラスに切り出す案をまとめる
- [ ] 「タグ命名」「カテゴリごとのグルーピング」「HUD/runner 系パラメータの扱い」のルールをコメント/Docstring で明文化する
- [ ] `mount()` が「Descriptor → ウィジェット構築 → ステージ/アンステージ」といった流れを分かりやすくラップするだけになる形を検討する

## 5. ParameterStore との同期/購読の整理

- [ ] `_on_store_change` / `sync_display_from_store` 周りの責務を整理し、「どのイベントで何を更新するか」を明文化する
- [ ] Store 側の API（`subscribe` / `unsubscribe` / `set_override` など）の使い方が一箇所にまとまるよう、専用の「ブリッジ」層を導入できるか検討する
- [ ] `runner.show_hud` を含む「ランタイム制御系パラメータ」が今後拡張されても破綻しないような拡張ポイントを設計する（必要に応じて TODO として残す）

## 6. ドライバスレッドとライフサイクルの明確化

- [ ] `_start_driver` / `_stop_driver` の役割とスレッドモデル（ループ条件・終了条件・例外処理）を整理する
- [ ] Dear PyGui の要求（メインスレッド制約など）と pyglet との関係をコメントで明示し、「このモジュールの責務範囲」をはっきりさせる
- [ ] 将来、他の UI 実装（別バックエンド）を導入する場合に、ドライバ部分を差し替えやすい構成にする案を TODO として記録する

## 7. 実装リファクタリング（段階的）

- [ ] 小さな内部関数の抽出・命名改善（ロジック共有/重複削減を目的とした変更）
- [ ] フォント/テーマ関連ロジックの切り出し（`_setup_fonts` の肥大化を抑える）
- [ ] レイアウト構築ロジックの切り出しと、`mount()` のシンプル化
- [ ] ParameterStore ブリッジ（購読/同期）の整理とコメント追加
- [ ] ドライバスレッド/ライフサイクル処理のコメント整備と、必要最低限の防御的コード（例外ログなど）の整理
- [ ] 既存テストの更新/追加（構造変更に伴い必要な範囲で）

## 8. 動作確認・テスト

- [ ] 変更範囲（`dpg_window.py` と関連ユーティリティ）に対して `ruff check --fix` / `black` / `isort` / `mypy` を実行
- [ ] `pytest -q tests/ui/parameters/test_dpg_mount_smoke.py` を中心に Parameter GUI 周辺のテストを実行
- [ ] 実機確認（可能であれば）: パラメータ GUI を起動し、表示/非表示切替、値変更、HUD/runner 系パラメータを実際に操作して挙動を確認

# 事前に相談したい点 / オーナー確認事項

- [ ] `ParameterWindow` の公開 API（コンストラクタ引数・公開メソッド）を「現状維持」する前提でよいか  
      → もし変更してよい場合、よりシンプルなインタフェース（例: `from_config(config)` ファクトリ等）を提案可能
- [ ] フォント探索ロジックを単純化（例: 「最初に見つかった候補のみ使用」など）してもよいか  
      → 現状はスコアリングなどを行っている場合、挙動が少し変わる可能性がある
- [ ] HUD/runner 系パラメータ（`runner.show_hud` など）の UI 側ロジックを、`api.sketch` 側仕様に合わせて見直すタイミングを「今回のリファクタ」に含めるかどうか
- [ ] 将来的に Dear PyGui 以外の UI 実装をサポートする予定の有無  
      → ある場合は、今回のリファクタ時点でインタフェース分離レベルをどこまでやるか調整したい

# 今後追記する事項（リファクタ中に気づいた点）

- リファクタリング作業中に発見した「仕様の曖昧さ」「別モジュールとの責務境界の不整合」「追加で検討すべき改善案」は、このファイル末尾に項目を追加していく
- 各チェックボックスの進捗（[ ] → [x]）も本ファイル上で更新し、「何が完了していて何が未完了か」を常に可視化する

