# dash エフェクト: 0 長ダッシュ時の不整合バグ 改善計画

## 背景 / 現状

- `dash_length=[0, 0, 0]` のように「全てのダッシュ長が 0」で、`gap_length` が正のときに `dash` エフェクトを適用すると例外が発生する。
- 例外は `Geometry` 生成時の `_normalize_geometry_input` で発生し、`offsets[-1] != coords.shape[0]` となっている。
- 原因は `dash` の 2 パス実装（`_count_line` と `_fill_line`）の間で「0 長ダッシュのみのケース」に対するフォールバック挙動が一致していないこと。
  - `_count_line` はダッシュ本数 `m==0` のとき `return n, 1` として「元の線を 1 行として保持する」つもりの no-op カウントを返す。
  - `_fill_line` は同じ状況で元線コピーのフォールバックを実行しておらず、実質的に何も書かない（`vc`/`oc` が増えない）。
  - その結果、確保済み `coords` と `offsets` が不整合な状態になり、`Geometry` の不変条件チェックで落ちる。

## ゴール

- `dash_length` / `gap_length` / `offset` の組が「実線を一切含まない」ケースでも `Geometry` の不変条件を満たすようにし、例外を発生させない。
- 0 長ダッシュを含むパターン（あるいは全て 0）のときも、挙動が明快かつ一貫したルールに従うようにする。
- 既存の正常ケース（0 でないダッシュ長が含まれるパターン）については挙動とパフォーマンスを維持する。

## 望ましい仕様（案）

- [x] `dash_length` / `gap_length` / `offset` の組から導かれる「ダッシュ区間」が 1 本も存在しない場合の挙動を明示的に定義する。
  - 候補 1: 完全 no-op（元の Geometry をそのまま返す）。
  - 候補 2: 「線は残すが全てギャップ」と解釈し、見た目は空（後続処理に依存）だが Geometry としては元線を返す。
- [x] 0 長ダッシュを含むパターンでも、`m`（生成されるダッシュ本数）の意味と `_fill_line` の書き込み挙動を一致させる。
- [x] `dash_length[i] + gap_length[j] <= 0` などパターン自体が不正な場合は、現行と同様に no-op（元 Geometry コピー）で統一する。
- [x] `offset` が大きく、実線部分が全てギャップ側に押し出されるケースでも、内部的に consistent な offsets/coords を生成する。

## 実装タスク案

- [x] `_count_line` と `_fill_line` で「ダッシュが 1 本も生成されない場合」の処理方針を統一する。
  - 例: `_count_line` が「no-op として元線を返す」意図で `(n, 1)` を返すなら、`_fill_line` もその条件で必ず元線コピーを書き込む。
  - もしくは、「ダッシュ 0 本」の場合は `_count_line` も `_fill_line` も「頂点 0 / 行 0」と扱い、外側の呼び出しで no-op を選択する。
- [x] 0 長ダッシュ（`dash_len == 0`）の扱いを明示的な分岐で実装し、`pattern = dash_len + gap_len` のみでは区別されないケースを整理する。
- [x] `offset` を考慮した u 軸ロジックにおいて、「[offset, L+offset]」とダッシュ区間が全く重ならない場合にも `vc`/`oc` が矛盾しないようにする。
- [x] 2 パス実装の計算量・メモリ確保方針は変えずに、分岐のみで整合性を取る（必要以上にロジックを複雑化しない）。

## テスト計画

- [x] 新規テストケースを `tests/effects/test_dash_basic.py` に追加する。
  - [x] `dash_length=[0.0, 0.0, 0.0], gap_length=[2.0, 2.0, 2.0]` で単一線（L>0）に適用し、例外が発生しないこと。
  - [x] 上記ケースで `out.coords` / `out.offsets` の関係（`offsets[-1] == coords.shape[0]`）が成立すること。
  - [ ] `dash_length=[0.0, 3.0, 0.0]` のように 0 長ダッシュを一部含むケースで、既存の挙動と矛盾しないこと（必要なら期待値を明示）。
  - [ ] `offset` を大きくしたケース（例: `offset` が L より十分大きい）で、例外が出ず Geometry が整合していること。
- [x] 既存の dash テスト（特に基本ケースと list パターン, offset パターン）を再実行し、回帰が無いことを確認する。

## ドキュメント / コメント

- [ ] `src/effects/dash.py` のモジュールヘッダに「ダッシュが 0 本になる場合の挙動（no-op かどうか）」を短く追記する。
- [ ] 0 長ダッシュ関連のロジックが直感的でない箇所（`_count_line` / `_fill_line`）には、簡潔なコメントで意図を残す。
- [ ] 必要に応じて `docs/effects_arguments.md` に「0 長ダッシュを指定した場合の注意」を 1 行程度で記載する。

## 要確認事項（相談したいポイント）

- [x] 「実線ゼロ」ケースのユーザー向け挙動をどちらに寄せるか（完全 no-op か、空描画だが元 Geometry を返すか）。；後者で
- [x] `offset` によるパターンシフトの結果として「見かけ上実線ゼロ」になるケースを、0 長ダッシュ指定と同一扱いにしてよいか。；はい
- [x] 今後の拡張（例えば「ダッシュ／ギャップ比率のみ指定」など）がこの仕様に影響しないか。；はい
