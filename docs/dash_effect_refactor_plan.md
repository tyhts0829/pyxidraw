# dash エフェクト: リファクタリング計画

## ゴール
- `src/effects/dash.py` の実装を「読んで理解しやすく、意図が明確」な形に整理する。
- 挙動とパフォーマンスを維持しつつ、重複ロジックやノイズの多い部分を削減する。
- Numba 対応コードを過度に複雑化せず、今後の性能改善や仕様変更に備えやすい構造にする。

## 現状の課題
- [ ] `_count_line` / `_fill_line` が似たロジック（弧長計算 / u→t 変換 / パターンサイクル）をそれぞれ別々に持っており、意図が読み取りにくい。
- [ ] 「原線コピー」フォールバック（n<2, L<=0, pattern<=0, written==0）の処理が複数箇所でほぼ同じコードとして繰り返されている。
- [ ] `dash_arr.astype(np.float64)` のように、実質的に冗長なキャストや分岐があり、読み手に「何か特別な意図があるのか？」と感じさせる部分がある。
- [ ] `offset` を考慮した u 軸→t 軸への変換ロジックが `_count_line` / `_fill_line` それぞれにほぼ同じ形で書かれており、DRY ではない。

## リファクタリング方針
- [ ] まず既存テスト（特に `tests/effects/test_dash_basic.py`）をリファクタ前後で必ず緑に維持することを前提とする。
- [ ] 性能特性（オーダーや Numba の有無による挙動）は変えず、あくまで「構造と読みやすさ」の改善に留める。
- [ ] Numba JIT 対応の制約（サポートされる Python 構文）を踏まえ、ヘルパー関数の分割や共通化は無理のない範囲に限定する。

## ステップ 1: 原線コピー処理の共通化
- [ ] `_fill_line` 内に散在する「原線コピー」ブロック（n<2, pattern<=0, L<=0, written==0）を洗い出す。
- [ ] Numba がサポート可能な範囲で、小さなヘルパー（例: `_copy_original_line(...)`）に抽出する。
- [ ] すべてのフォールバックケースがこのヘルパー経由で処理されるように整理し、意図をコメントで明示する。

## ステップ 2: u→t 変換ロジックの整理
- [ ] `_count_line` / `_fill_line` 双方に存在する「u 軸のダッシュ区間を [offset, L+offset] と交差させ、t=u-offset→[0,L] にクリップする」処理を比較し、差分を洗い出す。
- [ ] この変換ロジックを 1 箇所の関数（もしくは明確なコメント）として定義し、両者が同じ仕様に従っていることをわかりやすくする。
- [ ] 必要であれば、`u_start/u_end` 計算と t 軸へのマッピングを小さな Numba ヘルパーに切り出すことを検討する（Numba 制約を確認の上）。

## ステップ 3: 弧長計算部分の重複を整理
- [ ] `_count_line` / `_fill_line` 冒頭の弧長 `s` 計算（`np.sqrt(dx*dx+dy*dy+dz*dz)` の累積）を比較し、完全に同一であることを確認する。
- [ ] Numba 内ヘルパー関数に切り出すか、もしくはコメントで「同じロジックであること」を明示して、今後片側だけが変更されるのを防ぐ。
- [ ] 2 パスでの s 再計算自体は性能の観点からそのまま維持しつつ、「なぜ 2 回計算しているか」を docstring/コメントで補足する。

## ステップ 4: Python 層の軽微な整理
- [ ] `dash()` 内の冗長なキャストや分岐（`dash_arr.astype(np.float64)` など）を見直し、「意図がある変換」と「安全側の保険」を区別する。
- [ ] `max_len = n_dash if n_dash >= n_gap else n_gap` のような箇所を `max(n_dash, n_gap)` など、読みやすい形に統一する。
- [ ] `_as_float_seq` などのユーティリティ関数のエラーメッセージ・型チェックを簡潔にしつつ、仕様を docstring/コメントで補う。

## ステップ 5: テストと確認
- [ ] リファクタ後に `pytest -q tests/effects/test_dash_basic.py` を実行し、すべてのケースが緑であることを確認する。
- [ ] 可能であれば dash を含む UI/パラメータ系の簡易テスト（`tests/ui/parameters` の一部）も流し、実運用に近いパスで問題が出ないか確認する。
- [ ] 変更が多くなった場合は、`docs/dash_effect_refactor_plan.md` 自体を更新し、完了項目に `[x]` を付けておく。

