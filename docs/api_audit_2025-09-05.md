# API ディレクトリ監査レポート（2025-09-05）

本レポートは `api/` 配下のモジュール（公開エントリ、パイプライン、シェイプファクトリ、レジストリ、ランナー、型スタブ）を走査し、2025-09-03 の破壊的変更方針に対する整合性、レガシー痕跡、ドキュメント不整合の観点で洗い出したものです。

## サマリ

- **新方針準拠（概ねOK）**: `E.pipeline` の単層キャッシュ、`Geometry` 一体化、エフェクト関数の登録・解決は一貫して新設計に沿っています。
- **軽微な不整合/要補足**:
  - `Pipeline` キャッシュ上限の環境変数（`PXD_PIPELINE_CACHE_MAXSIZE`）が開発Tipsに未記載。
  - 生成系の型スタブ（`api/__init__.pyi`）に、旧/新が混在したパラメータ名（例: `displace` の `t_sec` と `time`）や、誤解を招きうる `size` 命名（`G.text`）が残存。
  - `api/shape_registry.py` に `CustomShape`/`ValidatedCustomShape` の互換ベースクラスがあるが、`shapes.registry.shape` が期待する `BaseShape` との継承階層が分離しており、拡張時に混乱の恐れ。
- **ドキュメントの改善余地**:
  - `api/__init__.py` の先頭Usageに、シリアライズAPI（`to_spec/from_spec/validate_spec`）の一言案内を追記すると導線がよくなる。
  - `G` 側のキャッシュ/推奨フローと「シェイプ側変換は非推奨」の注意は存在するが、README/architecture.md 側との相互参照を追加するとより明確。

---

## ファイル別の観察と指摘

### api/__init__.py

- 公開面の再エクスポート（`G`, `E`, `run/run_sketch`, `Geometry`, `to_spec/from_spec/validate_spec`）は新設計に準拠。
- 先頭の Usage は最新例（`G.sphere(...).scale(...).translate(...)` → `(E.pipeline ... .build())(g)`）に沿っており妥当。
- 追加提案: Usage 下にシリアライズAPIの例（`to_spec/validate_spec/from_spec`）を1行挿入すると流れが自然。

### api/pipeline.py

- `Pipeline` 本体と `PipelineBuilder` は新設計（単層LRU風キャッシュ、`E.pipeline` エントリ、`to_spec/from_spec/validate_spec`）に整合。
- 行 132 付近: `PXD_PIPELINE_CACHE_MAXSIZE` を読み取り、ビルド済みパイプラインの単層キャッシュ上限を初期化。
  - 現状 README/開発Tips には未記載（Tips はシェイプ生成LRU向けの `PXD_CACHE_DISABLED/PXD_CACHE_MAXSIZE` のみ）。
  - 提案: `README.md` の「開発向け Tips」に「パイプライン単層キャッシュ上限: `PXD_PIPELINE_CACHE_MAXSIZE`（整数、`None` で無制限）」を追記。
- `strict()` によるビルド時パラメータ検証は有用。テストスイートでのデフォルト有効化（またはサンプルコードに `.strict()` を明示）を検討。

参照:
- `api/pipeline.py` L120-L156 付近（`from_spec` 実装〜環境変数読取り）。

### api/shape_factory.py

- `G` の動的ディスパッチと LRU（`functools.lru_cache`）は良好。Usage も最新の推奨フロー（「生成→Geometry変換→加工」）を示している。
- ドキュメント中に「シェイプ側での変換パラメータは互換のため残るが推奨しない」と明記されており、新方針に沿う。
- 注意点（情報の明確化）:
  - 本モジュールのLRUは固定（環境変数では切替しない）旨の説明がある一方、`BaseShape` 側LRUの環境変数による制御（`PXD_CACHE_*`）にも触れており、相互の役割分担は理解できる。ただし README 側に「形状生成LRUは`G`に集約、`BaseShape`側は既定無効」の注記があるとより親切。

### api/shape_registry.py

- 役割: `shapes.registry` の薄い互換層（`get_shape_generator`/`list_registered_shapes` の再公開）。
- 懸念1: `CustomShape` / `ValidatedCustomShape` を `api/` 直下に定義（L41-L82）が、`shapes.registry.shape()` が想定する `shapes.base.BaseShape` 継承とは独立。
  - 実行時には（厳密な型検証がなければ）登録自体は可能でも、読者/拡張者に混乱を招く可能性が高い。
  - 提案: いずれかへ整理
    - A) `CustomShape` を `shapes.base.BaseShape` を継承する設計に改め、互換APIとして残す。
    - B) 拡張導線を `@shapes.registry.shape` + `BaseShape` に一本化し、本ファイルの抽象基底は削除（ドキュメントで移行ガイドへ誘導）。
- 付記: 当該ファイルのトップDocstringに「互換レイヤー」である旨は記載済みだが、具体的な「いつ使うか」を追記すると安全。

参照:
- `api/shape_registry.py` L41-L82（`CustomShape`/`ValidatedCustomShape`）。

### api/__init__.pyi（自動生成スタブ）

- 全体として型とDocstringは有用だが、以下の混在/曖昧さを検出:
  - `G.text(..., size=..., ...)` の `size` はフォントサイズを指すが、移行ガイドの「`size→scale`」と概念が衝突しやすい。
    - 提案: `font_size` または `size_mm` に改名（既存 `size` はエイリアスとして維持、Docstringに互換注記）。
    - 生成スクリプト `scripts/gen_g_stubs.py` 側で命名変換/別名出力対応が必要。
  - `E.pipeline.displace` の引数に `t_sec` と `time` が併存（旧/新の同義と思われる）。
    - 提案: 片方（例: `time`）を非推奨としてDocstringに明記、`validate_spec` での検査/変換方針をドキュメント化。

参照:
- `api/__init__.pyi` L127-L138（`text` の `size`）、L182-L191 付近（`displace` の `t_sec`/`time`）。

### api/runner.py

- `run_sketch` は `use_midi`/`midi_strict` のフォールバック戦略、ヘッドレス寄りの動作に配慮されており良好。
- README の「デモ: `python main.py --no-midi`」と引数名の整合は取れている（`use_midi=False` 相当）。必要に応じて、`runner.run_sketch(..., use_midi=False)` の短例を `api/__init__.py` Usage 末尾に追記すると導線が良い。

---

## 推奨アクション（優先度順）

1) ドキュメント補強（小）
- **Pipeline キャッシュ環境変数**: `README.md` の「開発向け Tips」に `PXD_PIPELINE_CACHE_MAXSIZE` を追記。
- **シリアライズAPIの導線**: `api/__init__.py` の Usage に `to_spec/validate_spec/from_spec` の例を1ブロック追加。

2) 命名/互換整備（中）
- **`G.text.size` の名称**: `font_size` か `size_mm` を正式化。`size` は互換エイリアス＋Docstringで移行注記。
- **`displace` の `t_sec`/`time`**: 片方を非推奨化し、`validate_spec` もしくはビルダーで警告/正規化（`warnings.warn` やログ）を検討。

3) 拡張導線の一本化（中〜大）
- **`api/shape_registry.py` の抽象基底**:
  - 案A: `CustomShape` を `shapes.base.BaseShape` 継承に変更し、`@shape` を用いた同一の拡張パスへ接続。
  - 案B: 互換クラスを廃止し、`BaseShape` + `@shape` への移行ガイド（コードサンプル付き）に置換。

---

## 確認観点チェックリスト（抜粋）

- Geometry 統一: `api/` から旧 `GeometryData` 参照は無し（OK）。
- 変換API: 使用例は `translate/scale/rotate/concat` に統一（OK）。
- エフェクト実装: `effects.registry.get_effect` で関数解決（OK）。
- パイプラインAPI: `E.pipeline ... .build()(g)` で統一（OK）。
- シリアライズ/検証: `to_spec/from_spec/validate_spec` を公開（OK、ただし Usage 追記推奨）。
- キャッシュ設定: 形状生成LRU（`PXD_CACHE_*`）はDocsに記載済み、パイプライン用（`PXD_PIPELINE_CACHE_MAXSIZE`）は未記載（要追記）。

---

## 付録: 参考スニペット（追記提案）

```python
from api import E, G, to_spec, from_spec, validate_spec

g = G.sphere(subdivisions=0.5).scale(100,100,100).translate(100,100,0)
pipeline = (E.pipeline
              .rotate(angles_rad=(0.5 * 3.141592653589793, 0, 0))
              .displace(amplitude_mm=0.2)
              .build())

spec = to_spec(pipeline)
validate_spec(spec)  # 例外が出なければOK
pipeline2 = from_spec(spec)
result = pipeline2(g)
```

---

本レポートは `api/` 配下のみを対象にしています。他ディレクトリ（`effects/`, `shapes/`, `engine/` 等）にも波及する命名/互換整理（特に `t_sec`/`time`, `size` 関連）の検証を行う場合は、続きの監査を実施可能です。

---

## 改善チェックリスト（進捗管理用）

- [ ] 基本方針: 本チェックリストは api 配下監査結果（2025-09-05）に基づく。完了時に対象ファイル/PR番号/スクショを記録すること。

**ドキュメント整備**

- [ ] D1-README: `PXD_PIPELINE_CACHE_MAXSIZE` を「開発向け Tips」に追記（意味、型、例、既定値/無制限の説明）。対象: `README.md`
- [ ] D2-Architecture: パイプライン単層キャッシュの設計背景と運用（LRU風・キー構成・最大件数）を補記。対象: `architecture.md`
- [ ] D3-API-Usage: `api/__init__.py` の Usage に `to_spec/validate_spec/from_spec` の短例を追加。対象: `api/__init__.py`（docstring）

**命名・スタブの整合**

- [ ] S1-Text-Arg: `G.text(..., size=...)` を正式名 `font_size`（または `size_mm`）に整理し、`size` は互換エイリアスとしてDocstringに明記。対象: `api/__init__.pyi`（生成元: `scripts/gen_g_stubs.py`）, 実装側 shapes（該当する場合）
- [ ] S2-Stubs-Regen: 生成スクリプト更新＋スタブ再生成（`python -m scripts.gen_g_stubs`）し、`G.text` の引数名/説明を反映。対象: `scripts/gen_g_stubs.py`, `api/__init__.pyi`
- [ ] S3-Docs-Migration: README の移行ガイドに「text のサイズは `font_size` を推奨、`size` は互換」の注記を追記。対象: `README.md`

**エフェクト引数の統一（displace）**

- [ ] E1-Canonical: 正式名を `t_sec` とし、`time` は非推奨エイリアスである旨をDocsに明記（effects/noise.py は既に DeprecationWarning 実装済み）。対象: `README.md`, `docs/*`（該当ページ）
- [ ] E2-Validate-Warn: `validate_spec()` またはビルド過程で、非推奨キー（`time`, `intensity`, `frequency`）検出時に `warnings.warn` を出すオプション（静的検出）を追加。対象: `api/pipeline.py`
- [ ] E3-Tests: 非推奨キーを使った spec が検証→実行まで通ること、かつ警告が出ることを確認。対象: `tests/test_pipeline_spec.py`（新規/既存拡張）

**レジストリ/拡張導線の一本化**

- [ ] R1-Decision: `api/shape_registry.py` の `CustomShape`/`ValidatedCustomShape` の扱いを決定（B推奨）。B案=互換基底を撤去し、`shapes.base.BaseShape` + `@shapes.registry.shape` に集約。対象: `api/shape_registry.py`
- [ ] R2-Deprecation: 上記クラスを即時削除が難しい場合は、import 時に `DeprecationWarning` を出す最小変更を入れ、削除予定を明記。対象: `api/shape_registry.py`, `docs/`（CHANGES/MIGRATION）
- [ ] R3-Docs-Guide: 「ユーザー拡張ガイド」を `BaseShape` + `@shape` で再掲（最小コード例つき）。対象: `docs/` または `README.md`

**使用例・導線の強化**

- [ ] X1-Runner-Example: `run_sketch(..., use_midi=False)` のヘッドレス利用例を API Usage 末尾に1行追加。対象: `api/__init__.py`（docstring）
- [ ] X2-Pipeline-Strict: サンプルに `.strict()` を1例追加（パラメータ名の早期検出を示す）。対象: `README.md` または `tutorials/*`

**テスト拡充**

- [ ] T1-Spec-RT: `to_spec/from_spec/validate_spec` の往復変換・エラー系（未登録名/不正型/未知キー）のテストを追加。対象: `tests/test_pipeline_spec.py`
- [ ] T2-Env-Cache: `PXD_PIPELINE_CACHE_MAXSIZE` 反映の単体テスト（0=無効、>0でLRU追い出し、None=無制限）。対象: `tests/test_pipeline_cache.py`
- [ ] T3-Text-Args: `G.text(font_size=...)` と `G.text(size=...)` が同結果になることの回帰テスト。対象: `tests/test_shapes_text.py`

**後方互換・移行告知**

- [ ] B1-Deprecation-Table: 非推奨引数（`size` for text, `time/intensity/frequency` for displace）の一覧表をDocsに追加（代替・削除予定バージョン・初出）。対象: `README.md` または `docs/migration.md`
- [ ] B2-Release-Notes: 変更要約をリリースノートに記載（環境変数追記、命名整理、拡張導線の明確化）。対象: `README.md` もしくは `docs/CHANGELOG.md`

**運用・整備**

- [ ] O1-Lint/Mypy: スタブ更新後の型チェックが通ること。対象: CI 設定/ローカル
- [ ] O2-Search-Replace: リポジトリ内で `G.text(.*size=)` の利用箇所を棚卸しし、`font_size=` への更新候補リストを出力。対象: 全体検索（PR説明に添付）
- [ ] O3-Examples-Sync: `tutorials/` や `screenshots/` 生成スクリプトの引数名を同期。対象: `tutorials/*`, `scripts/*`

---

## クリーン化（後方互換排除）チェックリスト

このセクションは「非推奨/互換を維持する改善チェックリスト」を置き換える前提の実行計画です。旧仕様は受け付けず、正規APIのみを許容します。

**コア実装**

- [ ] C1-displace-API: `effects/noise.py:displace` を新シグネチャのみに削減（`amplitude_mm`, `spatial_freq`, `t_sec`）。`intensity`/`frequency`/`time` と警告分岐を削除。`__param_meta__` を更新。
- [ ] C2-pipeline-strict-default: `PipelineBuilder.__init__` の既定を `self._strict = True` に変更（未知キーは常にビルド時例外）。
- [ ] C3-validate-spec-strict: `validate_spec` で各ステップのパラメータ名を関数シグネチャと突き合わせ、未知キーを `TypeError` にする（`**kwargs` 例外も撤廃）。
- [ ] C4-shape-registry-clean: `api/shape_registry.py` から `CustomShape`/`ValidatedCustomShape` を削除。拡張は `shapes.base.BaseShape` + `@shapes.registry.shape` に一本化。
- [ ] C5-text-arg-rename: `G.text` の引数名を `size` → `font_size`（または `size_mm`）へ改名し、旧名エイリアスを提供しない。
- [ ] C6-stub-generator: `scripts/gen_g_stubs.py` を更新し、上記改名を反映。`api/__init__.pyi` を再生成。
- [ ] C7-api-version: `api/__init__.py` の `__api_version__` をメジャーバンプ（例: `"4.0"`）し、`__breaking_changes__` を更新。

**リポジトリ一括更新**

- [ ] R1-replace-text-args: 全体から `G.text(size=...)` を `G.text(font_size=...)` に置換（必要箇所のみ）。
- [ ] R2-replace-displace-args: 旧引数 `time/intensity/frequency` の呼び出しを `t_sec/amplitude_mm/spatial_freq` に置換。
- [ ] R3-remove-compat-classes: `CustomShape`/`ValidatedCustomShape` 参照を削除/置換。

**テスト**

- [ ] T1-displace-tests: すべての `displace` テストを新シグネチャに統一。旧引数を使うテストは削除。
- [ ] T2-unknown-keys-fail: `PipelineBuilder` 既定 strict 化に合わせ、未知キーで確実に失敗するテストを追加。
- [ ] T3-text-font-size: `G.text(font_size=...)` の正常系テストを追加し、`size=` を使う既存テストは削除。
- [ ] T4-validate-spec-errors: `validate_spec` のエラー系（未登録名/未知キー/不正型）を網羅。

**ドキュメント**

- [ ] D1-readme-clean: README/Docs から「非推奨/互換」を撤去し、正規引数のみ記載。
- [ ] D2-migration-table: 移行ガイドを簡潔な置換表に更新（デプリ説明なし）。
  - `text.size → text.font_size`
  - `displace.time → displace.t_sec`
  - `displace.intensity → displace.amplitude_mm`
  - `displace.frequency → displace.spatial_freq`

**体験/サンプル**

- [ ] X1-examples-refresh: `README`/`tutorials` のコード断片を全て新引数に刷新。
- [ ] X2-pipeline-strict-sample: サンプルに `.strict()` を明示（既定Trueでも理解促進のため）。

**品質/運用**

- [ ] Q1-tests-cov: `python -m pytest -q` と `--cov` が緑で通る。
- [ ] Q2-mypy-precommit: 型チェックと `pre-commit` が通る。
- [ ] Q3-changelog: 破壊的変更の項を `docs/CHANGELOG.md` に追記し、タグ方針（例: v4.0.0）を明記。
