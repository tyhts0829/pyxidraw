# CC スナップショットの“総域（total）”化提案（破壊的変更可）

目的
- draw(t, cc) の `cc` を常に安全に `cc[idx]` で参照可能にする（KeyError を絶対に出さない）。
- 初回フレームでも `cc` が空にならず、0.0 を既定とする“安定した入力”を渡す。
- 既存のキャッシュ設計（有効パラメータが不変ならヒット）を崩さず、ユーザーに防御的な `cc.get()` を強要しない。

現状の問題
- 初回フレームは MIDI のスナップショットが未更新（`MidiService.tick()` 前）であるため `{}` が渡り得る。
- ユーザーが `cc[1]` と書いたときに `KeyError` が発生し、意図した「CC によるパラメータ制御」を始める前に落ちる。

提案（破壊的変更）
1) “総域（total）”の CC スナップショット
- draw に渡す `cc` を、`Mapping[int, float]` 互換だが「未登録キーも `0.0` を返す」オブジェクト（`CCSnapshot`）へ変更する。
- 仕様:
  - `cc[idx]` は常に `float` を返す（未登録は `0.0`）。
  - `cc.get(idx, default)` も使用可だが、既定は `0.0`。
  - `.keys()`/`.items()` は“実際に観測されたキー”を返す（密な 0..127 を列挙するとノイズが増えるため）。
  - `__repr__` は `{...}` の他に、`default=0.0` を明示（例: `CCSnapshot({1:0.5, 2:0.3}, default=0.0)`）。
- 互換性:
  - `KeyError` 前提のコードは壊れる（意図的破壊）。代替は `cc_raw = cc.raw()` を導入して「未登録キーは存在しない辞書」を取得（オプション）。

2) 初期化の安定化（ベター）
- ランナー初期化時（`run_sketch()`）に、MIDI サブシステムへ 1 回の `tick()` を試み、初期スナップショットを“温める”（デバイス未接続時は無視）。
- それでも未登録キーが多い場合は `CCSnapshot` の total 化により常に 0.0 が返るため、安全性は確保される。

3) CC プライマリとの整合
- Resolver（ValueResolver）は `CCBinding` を含む値に対し `midi_override` を設定し、ParameterStore.resolve の優先順（midi > gui > original）により CC をプライマリ扱いする。
- `cc` の total 化は “入力参照の安全化” であり、キャッシュや優先順位のロジックには影響を与えない。

4) キャッシュ設計への影響
- 量子化（`signature_tuple`）により「最終有効値」が不変であればヒットする現行設計は維持される。
- 初回フレームで CC が 0.0 デフォルトになることにより、初回の署名は（実ハードからスナップショット取得前でも）決まる。2 フレーム目に CC が非 0.0 なら署名が変わって裏ビルド→以後は新しい署名でヒットする。

5) API 仕様（要約）
- `draw(t, cc)` の `cc` は `CCSnapshot` となる。
  - `cc[idx] -> float`（未登録は 0.0）
  - `for k, v in cc.items()` は観測済みのキーのみ列挙
  - `cc.raw()` で現在観測済みのスナップショット（`dict[int,float]`）を取得（任意）
  - `repr(cc)` は `CCSnapshot({...}, default=0.0)` の形式
- 環境変数（任意）:
  - `PXD_CC_DEFAULT=0.0`（未登録キーの既定値。通常は 0.0 固定を推奨）
  - `PXD_CC_PRIME_TICK=1`（初期化時に `MidiService.tick()` を 1 回試行してから初回 draw を行う）

6) 代替案（検討のみ）
- 代替A: 「ユーザーが使う CC インデックス」を宣言して事前に埋める。
  - デメリット: 宣言が増えて書き味が悪くなる。draw の自由度が下がる。
- 代替B: 初回フレームを遅延（CC 更新を待ってから draw）。
  - デメリット: ランチャンで初期遅延/フリーズの印象を与える。ハード未接続時の扱いが難しい。
- 提案は「安全な total 化」で、ユーザーのコードを変えずに自然な UX を実現する。

7) 影響と移行
- 破壊的変更: `cc[idx]` での KeyError は発生しなくなります（`0.0` を返す）。
- 既存コードで KeyError をトリガに接続状態を判断している場合は、`cc.raw()`（観測済み）や別 API（`MidiService` 側の `is_connected()` 等）に置換します。
- ドキュメントとサンプル（main2.py）を更新し、「`cc[idx]` は常に安全、未登録は 0.0」と明記します。

8) テスト方針（変更ファイル優先）
- `CCSnapshot` の単体テスト（未登録キーへの `__getitem__` で 0.0）
- ランナー初期化時の `prime tick` オプションの on/off で初回 `cc` の repr と `.raw()` を検証
- 既存の Resolver/Store テストは影響なし（CCBinding と優先順は現状通り）

---
この提案により、ユーザーは draw 内で常に `cc[idx]` と書けばよく、防御的な `get()` を強いられません。初回フレームでも KeyError は発生せず、0.0 を既定とした一貫した入力でキャッシュ設計も維持されます。

