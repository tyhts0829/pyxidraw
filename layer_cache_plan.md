# レイヤーキャッシュ実装計画（案）

目的: Parameter GUI からレイヤーごとにキャッシュ（固定化）を切り替え、ON 時は幾何計算・GPU 転送を極力省いても該当レイヤーの描画を継続させる。

想定ゴール:

- Parameter GUI にレイヤー単位の「Cache」トグル（初期 OFF）を追加し、永続化も行う。
- Cache ON レイヤーは一度確定した Geometry/スタイルを保持し、時間`t`や CC に依存せず同じ絵を描き続ける。
- Cache OFF に戻した瞬間にキャッシュを無効化し、現行挙動（毎フレーム再計算）に復帰。
- 可能なら GPU への再アップロードを避け、固定レイヤーの再描画を最小コストで行う。

## 実装タスク案（チェックリスト）

- [ ] 仕様整理
  - [ ] キャッシュ対象の範囲を定義（Geometry 固定、スタイルは最新 override を反映するかを決める）。
  - [ ] レイヤー識別子の決定（name 優先 + 位置 fallback など）と、順序変化・欠落時の無効化ルール。
  - [ ] キャッシュ ON/OFF と永続化の扱い（初期値、セッション復元、リセット手順）。
  - [ ] 描画スキップ条件（全レイヤー固定時は draw 全体をスキップするか、部分固定時の合成方法）。
  - [ ] GPU 転送回避の段階目標（最低限: 固定レイヤーが新規フレーム無しでも描画維持、可能なら混在時も再アップロード抑制）。
- [ ] Parameter GUI/Store 対応
  - [ ] `ParameterManager._register_layer_descriptors` に cache トグル Descriptor を追加し、Style セクションに表示。
  - [ ] 保存/復元（persistence）に cache フラグを含め、スナップショット抽出にも載せる。
  - [ ] レイヤー名リストの保持方法を見直し（キーの安定化、表示ラベルの統一）。
- [ ] ランタイム/ワーカ側のキャッシュ管理
  - [ ] LayerCacheStore（仮）を設計し、`Layer` キーごとに実体 Geometry とスタイルを保持・無効化できるようにする。
  - [ ] `_execute_draw_to_packet` にキャッシュ適用を組み込み、該当レイヤーの計算スキップ/差し替え/再利用を制御。
  - [ ] LazyGeometry をキャッシュへ格納する際に実体化し、以降は `t`/CC 依存を遮断する。
  - [ ] パラメータ/CC のスナップショット適用とキャッシュの整合（cache ON 時はそれらを無視するかを明確化）。
- [ ] Renderer/描画経路の対応
  - [ ] 固定レイヤーを毎フレーム描画に含める仕組みを追加（例: frozen_layers スロットや renderer 側の常駐スナップショット）。
  - [ ] 変更のない固定レイヤーで GPU 転送をスキップする経路を検討（オフセット署名や cache_key を用いた再利用）し、難しければ安全なフォールバックを定義。
  - [ ] 動的レイヤーとの混在時でも描画順とスタイルが崩れないよう統合方法を決める。
- [ ] HUD/ドキュメント
  - [ ] HUD のキャッシュメトリクスにレイヤーキャッシュ状態を追加するか判断（不要なら明記）。
  - [ ] `architecture.md` にレイヤーキャッシュの流れと Parameter GUI 操作用トグルを追記。
- [ ] テスト/検証
  - [ ] LayerCacheStore の単体テスト（有効化/無効化/再利用/無効化条件）。
  - [ ] Parameter snapshot への cache フラグ混入を検証するテストを追加。
  - [ ] 可能なら headless での描画スモーク（固定レイヤー ON で `draw` をスキップしても表示維持するか）を追加。
  - [ ] 変更ファイルに対する `ruff`/`black`/`isort`/`mypy`/対象 `pytest` を実行。

## オープンな確認事項

- [ ] Cache ON 中に layer.color/thickness の GUI 変更を即時反映させるか、それともスタイルも固定とするか。；パフォーマンス的に不利にならないなら即時判定で。
- [ ] レイヤー識別は現行の name 優先 + `layer{idx}` fallback でよいか（ズレた場合にキャッシュを破棄する運用で問題ないか）。；はい
- [ ] GPU 転送最適化は「全レイヤー固定時はフレーム送信を止める」レベルで十分か、混在ケースでも転送スキップを求めるか。；「全レイヤー固定時はフレーム送信を止める」レベルで十分: すべてのレイヤーが Cache ON なら、Worker→Renderer への新規フレーム送出を止め（計算も GPU 転送もゼロ）、Renderer が保持する固定レイヤーのスナップショットだけを毎フレーム再描画する。
      混在ケースでも転送スキップを求める； 一部レイヤーだけ Cache ON、残りは動的な場合でも、固定レイヤーは新規フレームなしで再利用し、動的レイヤーだけを送る/アップロードするようにし、部分的に GPU 転送を減らす。
- [ ] Cache フラグの初期値と永続化方針（デフォルト OFF のままセッション保存する方針で良いか）。；デフォルト OFF で。ON にした状態で描画が終了した場合は、キャッシュ有効化時のパラメータを永続化して、次に再度スクリプトが実行されたときは、初回だけ再計算してすぐキャッシュ ON 状態にすることで、キャッシュが効いたまま再開したようなユーザー体験にする。
