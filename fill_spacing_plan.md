# fill `spacing` パラメータ導入・粗密制御 改善チェックリスト

目的: `fill` エフェクトで、`density` ではなく「倍率パターン解釈の `spacing`」を導入し、線間隔の粗密を周期的にコントロールできるようにする。

## 前提 / 現状整理（要確認）

- [ ] `fill` の現行仕様を整理する
  - [ ] 共平面パスでの `density` → `_spacing_from_height` → `spacing` 決定ロジック
  - [ ] 非共平面パス（`_fill_single_polygon` 経由）の `density` 処理
  - [ ] `fill.__param_meta__` と RangeHint の意味合い（密度=本数スケール）
  - [ ] 既存テストで `density` に依存している箇所の把握

## 実装方針（案）

- API レベル
  - `spacing` は「基準間隔に対する倍率」として解釈する。
  - スカラー指定: `spacing=1.0` で従来の `density` ベースの間隔と同等。
  - シーケンス指定: `spacing=(1.8, 5.1, 2.2)` のように複数倍率を与え、スキャンラインごとに周期的にサイクルさせる。
  - スキャンライン方向は現行と同じ（XY 平面／角度適用後の y 方向）。

- 生成ロジック（概念）
  - まず従来通り `_spacing_from_height` から「基準間隔 `base_spacing`」を求める。
  - スカラー `spacing` なら `effective_spacing = base_spacing * spacing` として、そのまま等間隔で配置。
  - シーケンス `spacing_seq` なら
    - `y = min_y`
    - `i = 0..` として `step_i = base_spacing * spacing_seq[i % len(spacing_seq)]`
    - `y += step_i` を繰り返しながらスキャンラインを生成する（周期的な粗密パターン）。
  - 共平面／非共平面どちらの経路でも同じ考え方を共有する。

## 実装タスクチェックリスト

1. 型と API 仕様の確定
   - [ ] `fill` のシグネチャ変更案を固める
     - 候補: `density` を廃止し、代わりに `spacing: float | list[float] | tuple[float, ...] = 1.0` を追加
     - もしくは一時的に `density` と `spacing` を共存させる（優先順を決める）
   - [ ] `spacing` の許容型: `float`, `list[float]`, `tuple[float, ...]`（他 Iterable はエラー）
   - [ ] 0 以下の値や NaN/inf の扱いルールを決める（例: 無視 or クランプ）

2. 内部パラメータ正規化ヘルパの追加
   - [ ] `spacing` を正規化するヘルパ関数を追加
     - スカラー → `[float]`
     - シーケンス → `list[float]` に変換し、0 以下をどう扱うか決める
   - [ ] グループ／ポリゴン単位で `spacing` をサイクルさせるルールを決める
     - 例: 図形グループごとに `spacing_seq[gi % len(spacing_seq)]` を「倍率パターン全体」として適用するか
     - もしくは「スキャンラインごとのサイクル」に直接渡すか

3. スキャンライン生成ロジックの拡張
   - [ ] `_generate_line_fill` に「倍率パターンによる非等間隔スキャン」を導入するか、新しいヘルパを切り出すか決める
   - [ ] `_generate_line_fill_evenodd_multi` でも同じ仕組みを使えるようにする
     - 現在の `np.arange(min_y, max_y, spacing)` では倍率パターンを扱えないため、`while y < max_y:` 形式に変更する案を検討
   - [ ] 共平面パスでの `spacing_glob`（グローバル共通間隔）との整合をとる
     - `spacing_glob` を `base_spacing` と見なし、そこに倍率パターンを掛ける設計を確認

4. `fill` 本体でのパラメータ適用
   - [ ] `density` から `spacing` への移行パスを実装
     - 完全に置き換えるか、内部で `spacing` に変換して互換を保つかを決める
   - [ ] 共平面（`planar_global=True`）パスで `spacing` を反映
   - [ ] 非共平面パス（`_fill_single_polygon`）で `spacing` を反映

5. UI / メタ情報 / 署名量子化
   - [ ] `fill.__param_meta__` に `spacing` 用エントリを追加し、`density` をどう扱うか決める
     - 例: `{"type": "number", "min": 0.1, "max": 10.0, "step": 0.05}` など
   - [ ] 署名生成（`params_signature`）での量子化ステップが妥当か確認
     - `spacing` は倍率なので、`step` はそこまで細かくしすぎない（例: 0.01 or 0.05）

6. テスト追加・既存テスト更新
   - [ ] `spacing` スカラー指定で、従来の `density` 相当の挙動になることを確認するテスト
   - [ ] シーケンス指定で周期的な粗密パターンが生成されることを確認するテスト
     - 例: `(1.0, 2.0)` で「広い間隔」と「狭い間隔」が交互に現れること
   - [ ] 共平面／非共平面の両経路で `spacing` が効いていることを確認
   - [ ] 既存の `density` 依存テストをどうするか決めて更新（廃止 or マッピング）

7. ドキュメント / アーキテクチャ更新
   - [ ] `fill` の docstring（`src/effects/fill.py`）を `spacing` ベースに更新
   - [ ] architecture.md に `fill` のパラメータ仕様があれば更新
   - [ ] UI 側の説明（もしあれば）も `spacing` 用に調整

## ユーザーに確認したいこと / 質問

- [ ] `density` は完全に廃止してよいか
  - それとも一度だけ互換レイヤーを挟み、`density` 指定時には内部で `spacing` に変換する形にするか。
- [ ] `spacing` の RangeHint をどうしたいか
  - 候補: `min=0.25, max=4.0, step=0.05`（倍率としての 1/4〜4倍）
  - もっと狭める／広げるなどの希望があれば反映する。
- [ ] 倍率パターンのサイクル方向
  - 現状案: 「スキャンライン（y 方向）の順番に沿って `(s0, s1, s2, ...)` を周期的に適用する」。
  - 図形中央を基準にしたい、など別の直感があれば設計を変える余地あり。

## 追加アイデア / 今後の改善候補

- [ ] 「一度きりの勾配」を付けるモード
  - 例: 図形の下から上にかけて連続的に密になるような補間モード（`spacing_gradient` のようなパラメータ）。
- [ ] 角度ごとに異なる粗密パターン
  - 例: 主方向は細かく、副方向は粗く、といった制御を `spacing_multi` で行う。

---

このチェックリストで問題なければ、上から順にタスクを進めつつ、完了項目にチェックを入れていきます。追加で気づいた論点や改善案があれば、このファイルに追記していきます。

