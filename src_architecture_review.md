# src モジュール設計レビュー（effects/shapes 以外）

- 目的: 可読性と責務分離（疎結合・高凝集）を高める観点でのアーキテクチャ/クラス設計レビュー。
- 対象: `api/`, `engine/`, `common/`, `util/`（`effects/` と `shapes/` 配下は除外）。

## 主な懸念点

- [H] ランナー関数がモノリシック化しておりテスタビリティ/再利用性が低い  
  `api/sketch.py:150-707` の `run_sketch` が設定解決、MIDI/Parameter GUI 立ち上げ、ワーカー/レンダラー結線、HUD/録画/UI イベント処理を単一関数内のネスト関数で握っている。責務が多層に跨っており、局所的な変更でも全体を読み解く必要があるほか、個別機能の単体テストが困難。`FrameClock` の tickables 管理や録画モード切替も同関数に閉じているため、ライフサイクル管理の検証も難しくなっている。→ `RunnerConfig`/`RunnerLifecycle` のような小さいオーケストレータへ分割し、(1)設定/依存の構築、(2)バックエンド結線、(3)UI/イベント束ね、(4)終了処理の段階をクラス/モジュールで分離すると読みやすくテストもしやすい。

- [M] Parameter GUI との結合が暗黙的（ContextVar 依存）で API 層の振る舞いが隠れる  
  `api/shapes.py:145-165` と `api/effects.py:226-305` が `engine.ui.parameters.get_active_runtime` への依存を持ち、アクティブランタイムの有無でパラメータ解決やバイパス判定の挙動が変わる。一方で `engine/ui/parameters/manager.py:29-135` では外部設定のパース・Descriptor 登録・ウィンドウ生成を一括で担っており、UI 有効/無効の境界や責務が曖昧。→ パラメータ解決を明示的な依存注入に寄せる（例: `ShapesAPI`/`PipelineBuilder` にオプション Resolver を渡す）か、少なくとも ContextVar をラップした薄いプロバイダを導入して API 層から UI 依存を見えやすくする。併せて `ParameterManager` は「設定→Layout/テーマ生成」と「ランタイム起動/寿命管理」に段階分割し、UI 無効時にも値解決だけ差し替えられる構成にすると凝集度が上がる。

- [M] キャッシュ戦略が分散しライフサイクルが不透明  
  `api/effects.py:26-211,354-376` の compiled/result キャッシュと、`engine/core/lazy_geometry.py:222-337` の shape/prefix キャッシュがそれぞれ独立に閾値/統計/クリア手段を持つ。`run_sketch` では compiled パイプラインのみ初期化しているが、形状/プレフィックスの寿命やワーカープロセス境界でのリセット規約はコードを辿らないと把握できない。→ キャッシュの責務をまとめたサービスを用意し、設定値・クリア API・HUD 向け統計を一元化するか、少なくとも各キャッシュのライフサイクル（プロセス内/フレーム内等）を明示的にドキュメント化して不意のメモリ保持や性能ばらつきを抑える。

- [M] スタイル抽出/レイヤー化が Worker 層に埋め込まれ、パイプライン仕様と乖離  
  `engine/runtime/worker.py:76-157` で `LazyGeometry` の plan から `style` step を剥がし、`StyledLayer` を組み立てる処理を Worker 側が担っている。エフェクト種別の知識が実行基盤に漏れており、スタイルの仕様変更や追加があるたびにワーカーを編集する必要がある。また Sequence と単体でほぼ同一の処理が二重化している。→ パイプライン側で「Geometry + style 属性」を明示した型（例: `StyledGeometry`）に正規化するコンバータを用意し、Worker ではフレーム組み立てのみを担当する構造に寄せると責務が明確になる。

## 開発時の補足メモ

- 現状は tests/ から設計を検証しにくい箇所が多いため、上記のように層ごとにクラス/関数を分割しておくと高速なユニットテストを書きやすくなる見込み。
- キャッシュのライフタイミングや UI 介在の境界を `architecture.md` に簡潔に追記すると、新規参加者がシステム全体の前提を掴みやすくなる。
