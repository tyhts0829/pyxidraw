# レイヤー導入 実装計画（叩き台）

目的:

- Geometry/LazyGeometry を明示的なレイヤーに束ね、色・太さをレイヤー起点で管理する。
- 静的/動的オブジェクトをレイヤー分離し、キャッシュ効率と G-code のペン交換運用を改善する。

前提:

- 現状は `E.style` エフェクトを plan から剥がして `StyledLayer` に変換する暫定レイヤー実装がある。
- Renderer はレイヤーの粘着色スナップショットを保持し、G-code ではレイヤー情報を潰している。

作業チェックリスト:

- [ ] API 設計: `L`（仮）によるレイヤー構築/操作インターフェースと公開位置を決める（`api/__init__.py` への追加方針含む）。
- [ ] データモデル: `Layer`（色・太さ・Geometry/LazyGeometry・任意メタ）型を定義し、`StyledLayer` からの移行方針を固める。
- [ ] 互換/廃止戦略: `E.style` 廃止に伴う既存パイプラインの互換策（デ precation フラグ or 即廃止）を決める。
- [ ] Runtime 正規化: `worker._normalize_to_layers` を新 Layer モデルに差し替え、Sequence/LazyGeometry/Geometry の返却規約を再定義。
- [ ] キャッシュ設計: レイヤー単位のキャッシュ鍵・無効化条件を決める（時間/cc を鍵に含めて自動失効。明示 invalidate API は現状なし）。
- [ ] Renderer: `LineRenderer` のレイヤー描画/スナップショット挙動を新モデルで維持/改善（粘着色リセット条件や太さリセット含む）。
- [ ] G-code: レイヤー情報を保持してエクスポートし、色/ペン交換指示をどう表現するかを設計する（ツールチェンジ・コメント等）。
- [ ] Parameter GUI: レイヤーの style 編集 UI 方針に従い、`engine.ui.parameters` の対応を定義する。
- [ ] ドキュメント: `architecture.md` / ルート `AGENTS.md` 最小項目へレイヤー仕様を反映する更新範囲を特定する。
- [ ] テスト計画: レイヤー API の単体（返却規約/キャッシュ鍵）と Renderer/Export への統合テストの追加・既存テストの改修範囲を列挙する。

オープン質問（合意済み）:

- `E.style` は即削除し、互換レイヤー変換ヘルパは置かない。
- `Layer` の色/太さはレイヤー定義が優先し、未指定時にグローバル定義を適用。
- レイヤーキャッシュはフレーム間共有を基本とし、時間/cc を鍵に含めて自動失効させる（明示 invalidate API は不要）。
- G-code のペン/色扱いは今回は実装不要。
- Parameter GUI は以下で進める:
  - レイヤーを API 側で明示構築し、初回フレームだけ id 付きで ParameterRuntime に登録→GUI 生成。以降は id 同期。
  - draw 内でレイヤー構成が変動しても、GUI 対象レイヤーは固定前提。可変レイヤーは GUI 対象外または read-only。
  - 毎フレームの暗黙スキャン/再生成は行わない（フリッカーと検証コスト回避）。
