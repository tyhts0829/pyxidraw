# ライン太さレビューと改善計画

## 問題概要
- 対象ファイル: `src/engine/render/shader.py:14`
- `line_thickness` がクリップ座標系の固定値 `0.0006` にハードコードされており、キャンバス寸法や `render_scale` の変更に追従しない。
- 現行のジオメトリ生成系は mm 単位を前提としているが、シェーダ側での太さは画面解像度に依存した擬似値のままになっている。

## 原因分析
- シェーダ定数を設定する経路が存在せず、Python 側から線幅を制御できない設計になっている。
- NDC 空間での固定オフセットのため、レンダリング解像度が上がると線が極端に細くなり、逆に低解像度では太く見える。
- `render_scale` やキャンバスサイズとは異なる空間で値を決めているため、アーキテクチャで定義された mm ベースの一貫性を損なっている。

## 影響範囲
- UI 上で `render_scale` を変更した際に線幅が視覚的に大きく変化し、レイアウトやエフェクトの印象が再現できなくなる。
- 将来的に線幅を調整するパラメータ GUI などを実装しようとしても、現状では NDC 固定値ゆえに設定のしようがない。

## 改善方針
1. **シェーダ定数の見直し**: `line_thickness` をシェーダ定数ではなくユニフォームとして外部から設定し、Clip 空間ハードコードを廃止する。
2. **mm→NDC 変換の導入**: `LineRenderer` 側で `render_scale` とキャンバス寸法から mm 単位の太さを算出し、シェーダへユニフォームで渡す。
3. **API 露出の検討**: ライン太さが変更可能になるよう、`LineRenderer` または上位 API (`run_sketch` 引数または設定) に制御パラメータを追加するか検討する。
4. **リグレッション確認**: 解像度・キャンバス寸法を変えても視覚的な太さが意図通りに保たれるか手動確認し、可能ならスモークテストの自動化を検討する。

## ユーザー制御の設計検討
- 要求: ユーザーが `draw` 関数内で線の太さをフレーム単位で変更可能にする。
- 想定アプローチ:
  - `RenderPacket` に線幅情報（mm 単位）を追加し、ワーカー→メインスレッド間で伝搬させる。
  - ユーザーコードからは `api.render.set_line_width(mm: float)`（仮）を呼び出し、スレッドローカルな `RenderStyleContext` に値を格納する。
  - WorkerPool がフレーム生成後に `RenderStyleContext.fetch()` を呼び出し、取得した値を `RenderPacket` に詰める。未指定時はデフォルト幅を使用する。
  - メインスレッド側の `LineRenderer.tick()` でパケット受信時にユニフォームへ反映する。
- 付随設計: Parameter GUI と連携する場合は `ParameterManager` が同コンテキスト API を透過的に利用できるようにする（パラメータ調整値を `set_line_width` に適用）。

## 作業チェックリスト
- [ ] ジオメトリシェーダから固定値 `line_thickness` を除去し、`uniform float line_thickness_ndc` の形で受け取るようにする。
- [ ] `LineRenderer` 初期化時にシェーダプログラムへ厚みユニフォームを取得し、更新できるようハンドルを保持する。
- [ ] `run_sketch` から `LineRenderer` へキャンバス寸法と `render_scale` を渡し、mm→NDC 変換ロジックを `LineRenderer` 内に実装する。
- [ ] デフォルトの線幅（mm 単位）と最小/最大値のクランプ方針を決定し、ユニフォーム更新処理で適用する。
- [ ] ライン太さの外部設定経路（例: `run_sketch(..., line_width_mm=...)` または設定ファイル）を設計し、必要なら Parameter GUI への露出可否も検討する。
- [ ] `RenderPacket` に線幅フィールドを追加し、`WorkerPool`・`StreamReceiver`・`LineRenderer` 間で伝搬するデータフローを整備する。
- [ ] ユーザー向け API（仮: `api.render.set_line_width`）と `RenderStyleContext` のデザインを確定し、Parameter GUI 経由の上書き方針を整理する。
- [ ] 解像度を変えた環境での目視確認手順を準備し、可能であれば自動テストまたはガイドラインを整備する。
- [ ] 仕様変更に伴うドキュメント（`architecture.md` など）とコードコメントを更新し、一貫性を確保する。

## 未解決リスク・懸念
- mm ベースの太さにすると極端に細い線が見えなくなる場合があるため、最小・最大値のクランプ方針が必要。
- ユーザーがパイプライン内で線幅を制御したいケースに対し、どの層でパラメータ化するか追加設計が必要。
- `RenderPacket` 拡張によりシリアライズ負荷がわずかに増える。必要以上のスタイル情報を持たせないよう注意する。
